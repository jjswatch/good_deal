<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¨­å®šå¸¸å»è³£å ´ï½œGoodDeal</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
        .container { max-width: 500px; margin: 0 auto; padding: 20px 16px; }
        .header { margin-bottom: 24px; }
        .header h1 { font-size: 20px; margin-bottom: 8px; }
        .header p { color: #64748b; font-size: 14px; }

        /* è³£å ´å¡ç‰‡ç¶²æ ¼ */
        .store-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 30px;
        }

        .store-item {
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .store-item:hover { border-color: #ddd6fe; }

        /* é¸ä¸­ç‹€æ…‹ */
        .store-item.active {
            border-color: #7c3aed;
            background: #f5f3ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.1);
        }

        .store-item .badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #7c3aed;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .store-item.active .badge { display: flex; }

        .store-name { font-weight: 700; display: block; margin-top: 8px; }
        
        .footer-action {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 16px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
        }
        
        .btn-save-stores {
            max-width: 468px;
            width: 100%;
            background: #7c3aed;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-save-stores:disabled { background: #cbd5e1; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“ æˆ‘çš„å¸¸å»è³£å ´</h1>
        <p>è«‹é¸æ“‡ 1~3 é–“æ‚¨æœ€å¸¸æ¶ˆè²»çš„è³£å ´ï¼Œæˆ‘å€‘å°‡ç‚ºæ‚¨å„ªå…ˆè¨ˆç®—é€™äº›åº—å®¶çš„å„ªæƒ çµ„åˆã€‚</p>
    </div>

    <div id="storeGrid" class="store-grid">
        <div style="text-align:center; color:#94a3b8; grid-column: 1/-1; padding:40px;">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="footer-action">
    <button id="saveBtn" class="btn-save-stores" onclick="savePreferredStores()" disabled>å„²å­˜è¨­å®š (0/3)</button>
</div>

<script src="js/auth.js"></script>
<script src="js/api.js"></script>
<script>
    let allStores = [];
    let selectedStoreIds = [];

    document.addEventListener("DOMContentLoaded", async () => {
    	const user = await apiGet("/user/profile");
        if (!user) { location.href = "login.html"; return; }

        try {
            // 1. å–å¾—æ‰€æœ‰è³£å ´
            allStores = await apiGet("/stores"); // éœ€ç¢ºèªå¾Œç«¯æœ‰æ­¤ API
            // 2. å–å¾—ä½¿ç”¨è€…ç›®å‰çš„è¨­å®š
            const currentPrefs = await apiGet(`/user/preferred-stores/${user.userId}`);
            selectedStoreIds = currentPrefs.map(p => p.store.storeId);
            
            renderStores();
            updateButton();
        } catch (e) {
            console.error(e);
            alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
    });

    function renderStores() {
        const grid = document.getElementById("storeGrid");
        grid.innerHTML = allStores.map(store => {
            const isActive = selectedStoreIds.includes(store.storeId);
            const order = selectedStoreIds.indexOf(store.storeId) + 1;
            return `
                <div class="store-item ${isActive ? 'active' : ''}" onclick="toggleStore(${store.storeId})">
                    <div class="badge">${order}</div>
                    <div style="font-size: 24px;">${getStoreEmoji(store.storeName)}</div>
                    <span class="store-name">${store.storeName}</span>
                </div>
            `;
        }).join("");
    }

    function toggleStore(id) {
        const index = selectedStoreIds.indexOf(id);
        if (index > -1) {
            // å·²é¸å– -> ç§»é™¤
            selectedStoreIds.splice(index, 1);
        } else {
            // æœªé¸å– -> æª¢æŸ¥ä¸Šé™
            if (selectedStoreIds.length >= 3) {
                alert("æœ€å¤šåªèƒ½é¸æ“‡ 3 é–“è³£å ´å–”ï¼");
                return;
            }
            selectedStoreIds.push(id);
        }
        renderStores();
        updateButton();
    }

    function updateButton() {
        const btn = document.getElementById("saveBtn");
        btn.disabled = selectedStoreIds.length === 0;
        btn.innerText = `å„²å­˜è¨­å®š (${selectedStoreIds.length}/3)`;
    }

    async function savePreferredStores() {
        const user = getCurrentUser();
        const userId = user.userId || user.id;
        if (!userId) {
            alert("æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥");
            location.href = "login.html";
            return;
        }
        const payload = {
            userId: userId,
            storeIds: selectedStoreIds // ç¢ºä¿é€™æ˜¯ [1, 2, 3] é€™æ¨£çš„é™£åˆ—
        };

        console.log("æº–å‚™å‚³é€çš„è³‡æ–™ï¼š", payload);

        try {
            await apiPost("/user/preferred-stores/sync", payload);
            alert("è³£å ´åå¥½å·²æ›´æ–°ï¼");
            location.href = "profile.html";
        } catch (err) {
        	console.error("åŒæ­¥å¤±æ•—:", err);
            alert("å„²å­˜å¤±æ•—ï¼š" + err.message);
        }
    }

    function getStoreEmoji(name) {
        if (name.includes("å…¨è¯")) return "ğŸ§§";
        if (name.includes("å®¶æ¨‚ç¦")) return "ğŸ”µ";
        if (name.includes("å¥½å¸‚å¤š")) return "ğŸ“¦";
        if (name.includes("å¤§æ½¤ç™¼")) return "ğŸ”´";
        return "ğŸª";
    }
</script>
</body>
</html>