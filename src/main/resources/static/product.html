<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GoodDealï½œå•†å“æ¯”åƒ¹å¹³å°</title>
<link rel="stylesheet" href="css/style.css" />
<!-- PWA è¨»å†Š -->
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>

/* å•†å“å¡ç‰‡ */
#productInfo {
	max-width: 1100px;
	margin: 20px auto;
	background: white;
	border-radius: 14px;
	padding: 20px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
	text-align: center;
}

#productInfo img {
	width: 180px;
	height: 180px;
	object-fit: cover;
	border-radius: 10px;
	margin-bottom: 16px;
}

.product-name {
	font-size: 22px;
	margin-bottom: 10px;
	font-weight: bold;
}

.product-desc {
	font-size: 15px;
	color: #555;
	margin-bottom: 20px;
	line-height: 1.6;
}

/* æœ€ä½åƒ¹å¡ç‰‡å®¹å™¨ */
.price-summary {
    display: inline-block;
    background: #f8fafc;
    border: 1.5px dashed #cbd5e1;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    width: 100%;
    max-width: 400px;
    text-align: left;
}

.price-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.price-item:last-child { margin-bottom: 0; }

.label-pill {
    background: #e2e8f0;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    color: #475569;
    font-weight: 600;
}

.price-item.history .label-pill {
    background: #fee2e2;
    color: #ef4444;
}

.price-value {
    font-size: 24px;
    font-weight: 800;
    color: #1e293b;
}

.store-name {
    display: block;
    font-size: 12px;
    color: #94a3b8;
    text-align: right;
}

.price-hint {
    margin-top: 15px;
    padding-top: 12px;
    border-top: 1px solid #e2e8f0;
    font-size: 14px;
    font-weight: 600;
    color: #059669; /* é è¨­ç¶ è‰² (å»ºè­°å…¥æ‰‹) */
    text-align: center;
}

/* å”¯ä¸€çš„æœ€ä½åƒ¹æ¨™ç±¤æ¨£å¼ */
.best-price-card {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 15px 30px;
    margin: 20px 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.best-price-label {
    font-size: 13px;
    font-weight: 700;
    padding: 4px 12px;
    border-radius: 50px;
    margin-bottom: 8px;
    text-transform: uppercase;
}

/* æ­·å²æœ€ä½ï¼šé‡‘ç´…è‰²èª¿ */
.label-history {
    background: #fee2e2;
    color: #ef4444;
    border: 1px solid #fecaca;
}

/* è¿‘æœŸæœ€ä½ï¼šè—è‰²èª¿ */
.label-recent {
    background: #dbeafe;
    color: #2563eb;
    border: 1px solid #bfdbfe;
}

.best-price-value {
    font-size: 32px;
    font-weight: 900;
    color: #1e293b;
    line-height: 1;
}

.best-price-store {
    font-size: 14px;
    color: #64748b;
    margin-top: 5px;
}

/* æŒ‰éˆ•çµ±ä¸€æ¨£å¼ */
a.button {
	display: inline-block;
	padding: 12px 20px;
	background: black;
	color: white;
	border-radius: 10px;
	text-decoration: none;
	font-size: 16px;
	margin: 10px;
	transition: 0.2s;
}

a.button:hover {
	background: #333;
}

.report-item {
    background: #fff;
    border: 1px solid #edf2f7;
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.report-user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 32px;
    height: 32px;
    background: #e2e8f0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #64748b;
}

.report-details {
    font-size: 14px;
}

.report-store-tag {
    font-size: 11px;
    background: #f1f5f9;
    color: #475569;
    padding: 2px 8px;
    border-radius: 4px;
    margin-right: 5px;
}

.report-price {
    font-weight: 700;
    color: #ef4444;
}

.report-time {
    font-size: 12px;
    color: #94a3b8;
}
/* è¶¨å‹¢åœ–å®¹å™¨ */
.mini-chart-container {
	position: relative;
    width: 100%;
    height: 80px;
    margin-top: 15px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    overflow: hidden;
}

/* åƒ¹æ ¼å»ºè­°æ¨™ç±¤ */
.buy-signal {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 5px;
}
.signal-buy { background: #d1fae5; color: #059669; } /* å»ºè­°å…¥æ‰‹ */
.signal-wait { background: #fef3c7; color: #d97706; } /* å»ºè­°è§€æœ› */
@media (max-width: 768px) {
    /* 1. ç¸®æ¸›å®¹å™¨é‚Šè·ï¼Œè®“å…§å®¹æ›´ç·Šæ¹Š */
    #productInfo {
        margin: 10px;
        padding: 15px;
    }

    /* 2. è®“å•†å“åœ–ç‰‡ç¨å¾®ç¸®å°ä¸€é»ï¼Œä¸¦ä¿æŒæ¯”ä¾‹ */
    #productInfo img {
        width: 140px;
        height: 140px;
    }

    /* 3. è®“æœ€ä½åƒ¹å¡ç‰‡å¼·åˆ¶ 100% å¯¬åº¦ï¼Œä¸å†ç¸®åœ¨ä¸­é–“ */
    .best-price-card {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        width: min(100%, 420px);
        box-sizing: border-box;
        padding: 15px;
    }

    /* 4. åƒ¹æ ¼å­—é«”å¾®èª¿ */
    .best-price-value {
        font-size: 28px;
    }

    /* 5. ä¸‹æ–¹æŒ‰éˆ•æ”¹ç‚ºä¸¦æ’ï¼Œæ–¹ä¾¿å¤§æ‹‡æŒ‡é»æ“Š */
    .button-group {
        display: flex;
        gap: 10px;
        padding: 0 10px;
    }
    
    a.button {
        flex: 1; /* å…©å€‹æŒ‰éˆ•å¹³åˆ†å¯¬åº¦ */
        margin: 5px 0;
        text-align: center;
        padding: 15px 5px;
        font-size: 14px;
    }
}
</style>
</head>

<body>


<div id="productInfo">
	<!-- JS å‹•æ…‹æ³¨å…¥å…§å®¹ã€‚ä¾‹å¦‚ï¼š
    <img src="...">
    <div class="product-name">å•†å“åç¨±</div>
    <div class="product-desc">æè¿°å…§å®¹</div>
    -->
</div>

<div style="text-align: center; margin-top: 10px;">
    <button onclick="openReportModal()" style="background: #FF4500; border: none;" class="button">
        ğŸ“¢ æˆ‘è¦å›å ±æ–°åƒ¹æ ¼
    </button>
</div>

<div id="reportModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:25px; border-radius:16px; width:90%; max-width:400px; position:relative;">
        <h3>å›å ±å•†å“åƒ¹æ ¼</h3>
        <p id="modalProductName" style="color:#666; font-size:14px;"></p>
        
        <div style="margin-bottom:15px; text-align:left;">
            <label style="display:block; margin-bottom:5px;">é€šè·¯åº—å®¶</label>
            <select id="reportStore" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
    			<option value="">è«‹é¸æ“‡åº—å®¶</option>
			</select>
        </div>

        <div style="margin-bottom:20px; text-align:left;">
            <label style="display:block; margin-bottom:5px;">å›å ±åƒ¹æ ¼ ($)</label>
            <input type="number" id="reportPrice" placeholder="è«‹è¼¸å…¥çœ‹åˆ°çš„åƒ¹æ ¼" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box;">
        </div>

        <button onclick="submitReport()" style="width:100%; background:#FF4500;" class="button">é€å‡ºå›å ±</button>
        <button onclick="closeReportModal()" style="width:100%; background:#999;" class="button">å–æ¶ˆ</button>
    </div>
</div>

<div class="report-section" style="max-width: 1100px; margin: 30px auto; padding: 0 20px; text-align: left;">
    <h3 style="font-size: 18px; border-left: 4px solid #FF4500; padding-left: 10px; margin-bottom: 15px;">
        æœ€æ–°æœƒå“¡å›å ±åƒ¹æ ¼
    </h3>
    <ul id="reportList" style="list-style: none; padding: 0;">
        <li style="color: #94a3b8; text-align: center; padding: 20px;">è¼‰å…¥å›å ±ç´€éŒ„ä¸­...</li>
    </ul>
</div>

<div class="button-group" style="text-align: center; max-width: 1100px; margin: 0 auto;">
    <a id="compareBtn" class="button" onclick="goCompare()">æŸ¥çœ‹æ¯”åƒ¹</a>
    <a id="historyBtn" class="button" onclick="goHistory()">æŸ¥çœ‹æ­·å²åƒ¹æ ¼</a>
</div>

<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/components.js"></script>
<script>
const params = new URLSearchParams(window.location.search);
const productId = params.get("id");

if (productId) {
    initProductPage(productId);
}

async function initProductPage(id) {
    try {
        // 1. åŒæ™‚ç²å–å•†å“è³‡è¨Šèˆ‡åƒ¹æ ¼æ•¸æ“š (ä¸¦è¡Œè«‹æ±‚æ•ˆèƒ½æ›´å¥½)
        const [product, prices] = await Promise.all([
        	apiGetPublic(`/products/${id}`),
        	apiGetPublic(`/products/${id}/price-lowest`)
        ]);

        renderProductBasic(product);
        renderPriceSummary(prices);
        renderReportList(id);

        let historyData = getCachedHistory(id);

        if (!historyData) {
            historyData = await apiGetPublic(`/history/product/${id}`);
            setCachedHistory(id, historyData);
        }

        if (historyData && historyData.length >= 2) {
            const chartPrices = historyData
                .map(item => item.newPrice)
                .reverse();
            renderMiniChart(chartPrices);
        } else {
            renderMiniChart();
        }
    } catch (err) {
    	console.error("è³‡æ–™æŠ“å–å¤±æ•—:", err);
    }
}

function renderPriceSummaryWithRealData(currentPrice, historyList) {
    // å°‡å¾Œç«¯æŠ“åˆ°çš„æ­·å²ç´€éŒ„è½‰ç‚ºåœ–è¡¨éœ€è¦çš„é™£åˆ— (å–å‡ºåƒ¹æ ¼ï¼Œä¸¦åè½‰é †åºè®“æ™‚é–“ç”±å·¦å¾€å³)
    const chartPrices = historyList.map(item => item.newPrice).reverse();
    
    // æ¸²æŸ“ UI (å¦‚åŒä¹‹å‰å¯«çš„ï¼Œä½†å¸¶å…¥ chartPrices)
    renderMiniChart(chartPrices); 
}

async function loadStoreOptions() {
    const select = document.getElementById("reportStore");
    select.innerHTML = `<option value="">è«‹é¸æ“‡åº—å®¶</option>`;

    try {
        const stores = await apiGetPublic("/stores");

        stores.forEach(store => {
            const opt = document.createElement("option");
            opt.value = store.storeId;          // â­ ä¸€å®šæ˜¯ ID
            opt.textContent = store.storeName;
            select.appendChild(opt);
        });

    } catch (err) {
        console.error("è¼‰å…¥åº—å®¶å¤±æ•—", err);
        select.innerHTML = `<option value="">ç„¡æ³•è¼‰å…¥åº—å®¶</option>`;
    }
}

async function renderReportList(productId) {
    const listContainer = document.getElementById("reportList");
    listContainer.innerHTML = `<li style="color:#94a3b8; text-align:center;">è¼‰å…¥ä¸­...</li>`;

    try {
        const reports = await apiGetPublic(
            `/price-reports/product/${productId}?limit=5`
        );

        if (!reports || reports.length === 0) {
            listContainer.innerHTML = `
                <li style="color:#94a3b8; text-align:center;">
                    å°šç„¡æœƒå“¡å›å ±åƒ¹æ ¼
                </li>`;
            return;
        }

        listContainer.innerHTML = reports.map(r => `
            <li class="report-item">
                <div class="report-user-info">
                    <div class="user-avatar">
                        ${(r.userName || "U").charAt(0)} 
                    </div>
                    <div class="report-details">
                        <span class="report-store-tag">${r.storeName}</span>
                        <strong>${r.userName}</strong> å›å ±
                        <span class="report-price">$${r.price}</span>
                    </div>
                </div>
                <div class="report-time">
                    ${formatTimeAgo(r.date)}
                </div>
            </li>
        `).join("");

    } catch (err) {
        console.error("æ¸²æŸ“æ¸…å–®å¤±æ•—:", err);
        listContainer.innerHTML = `
            <li style="color:#ef4444; text-align:center;">
                å›å ±ç´€éŒ„è¼‰å…¥å¤±æ•—
            </li>`;
    }
}

function formatTimeAgo(time) {
    const diff = (Date.now() - new Date(time)) / 1000;
    if (diff < 60) return "å‰›å‰›";
    if (diff < 3600) return `${Math.floor(diff / 60)} åˆ†é˜å‰`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} å°æ™‚å‰`;
    return `${Math.floor(diff / 86400)} å¤©å‰`;
}

function renderProductBasic(p) {
    document.getElementById("productInfo").innerHTML = `
        <h2 class="product-name">${p.brand} ${p.productName}</h2>
        <img src="${p.imageUrl || 'assets/placeholder.png'}" alt="${p.productName}">
        <div id="price-container"></div> <p class="product-desc">${p.description || "ç„¡å•†å“ä»‹ç´¹"}</p>
        <div style="color: #64748b; font-size: 14px;">
            <p>è¦æ ¼ï¼š${p.spec}</p>
            <p>æ¢ç¢¼ï¼š${p.barcode}</p>
        </div>
    `;
    
    // æ›´æ–°ä¸‹æ–¹æŒ‰éˆ•é€£çµ
    document.getElementById("compareBtn").href = `compare.html?id=${p.productId}`;
    document.getElementById("historyBtn").href = `history.html?productId=${p.productId}`;
}

function renderPriceSummary(data) {
    const container = document.getElementById("price-container");
    const history = data.historical;
    const recent = data.recent30Days;

    if (!history && !recent) {
        container.innerHTML = `<p style="color:#94a3b8">ç›®å‰æš«ç„¡åƒ¹æ ¼ç´€éŒ„</p>`;
        return;
    }

    // æ±ºå®šé¡¯ç¤ºå“ªä¸€ç­†è³‡æ–™çš„é‚è¼¯
    let displayData = recent || history;
    let labelText = recent ? "âš¡ è¿‘ 30 å¤©æœ€ä½" : "ğŸ† æ­·å²æœ€ä½åƒ¹";
    let labelClass = recent ? "label-recent" : "label-history";

 // âœ¨ åˆ¤æ–·æ˜¯å¦å»ºè­°å…¥æ‰‹ (ç°¡å–®é‚è¼¯ï¼šè‹¥ç›®å‰åƒ¹æ ¼æ¯”æ­·å²æœ€ä½åƒ¹é«˜å‡ºä¸åˆ° 5%ï¼Œå°±å»ºè­°å…¥æ‰‹)
    const isGoodPrice = history ? (displayData.price <= history.price * 1.05) : true;
    const signalHTML = isGoodPrice 
        ? `<span class="buy-signal signal-buy">ğŸ”¥ å»ºè­°å…¥æ‰‹</span>` 
        : `<span class="buy-signal signal-wait">â³ å»ºè­°è§€æœ›</span>`;

    container.innerHTML = `
        <div class="best-price-card">
            <span class="best-price-label ${labelClass}">${labelText}</span>
            <div class="best-price-value">
                $${displayData.price}
                ${signalHTML}
            </div>
            <div class="mini-chart-container">
                <canvas id="miniTrendChart"></canvas>
            </div>
        </div>
    `;

    // æ¸²æŸ“åœ–è¡¨ (æ¨¡æ“¬æœ€è¿‘ 7 æ¬¡çš„åƒ¹æ ¼æ³¢å‹•)
    renderMiniChart();
}

let miniChartInstance = null;

function renderMiniChart(realData = null) {
    const canvas = document.getElementById('miniTrendChart');
    if (!canvas) return; // ç¢ºä¿ç•«å¸ƒå­˜åœ¨
    const ctx = canvas.getContext('2d');
    
    // âœ¨ é—œéµï¼šå¦‚æœå·²ç¶“æœ‰åœ–è¡¨åœ¨è·‘ï¼Œå…ˆéŠ·æ¯€å®ƒï¼Œé¿å…ç„¡é™å¢é•·æˆ–è¨˜æ†¶é«”æ´©æ¼
    if (miniChartInstance) {
        miniChartInstance.destroy();
    }

    // å¦‚æœæ²’æœ‰å‚³å…¥çœŸå¯¦è³‡æ–™ï¼Œå°±ç”¨æ¨¡æ“¬æ•¸æ“šï¼ˆæ–¹ä¾¿é–‹ç™¼æ¸¬è©¦ï¼‰
    const dataToUse = realData || [159, 155, 160, 145, 145, 142, 139]; 
    
    miniChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dataToUse.map(() => ''), // æ ¹æ“šè³‡æ–™é•·åº¦ç”¢ç”Ÿæ¨™ç±¤
            datasets: [{
                data: dataToUse,
                borderColor: '#FF4500',
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                backgroundColor: 'rgba(255, 69, 0, 0.05)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // ğŸ’¡ æ­é…çˆ¶å®¹å™¨ position: relative ä½¿ç”¨
            animation: {
                duration: 800 // å¢åŠ ä¸€é»å‹•ç•«æ„Ÿ
            },
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            scales: {
                x: { display: false },
                y: { display: false, beginAtZero: false }
            }
        }
    });
}

const HISTORY_CACHE_TTL = 10 * 60 * 1000; // 10 åˆ†é˜

function getCachedHistory(productId) {
    const key = `priceHistory_${productId}`;
    const raw = localStorage.getItem(key);
    if (!raw) return null;

    try {
        const cached = JSON.parse(raw);
        if (Date.now() - cached.timestamp > HISTORY_CACHE_TTL) {
            localStorage.removeItem(key);
            return null;
        }
        return cached.data;
    } catch {
        localStorage.removeItem(key);
        return null;
    }
}

function setCachedHistory(productId, data) {
    const key = `priceHistory_${productId}`;
    localStorage.setItem(key, JSON.stringify({
        timestamp: Date.now(),
        data
    }));
}


//1. é–‹å•Ÿå½ˆçª—
function openReportModal() {
    const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
    if (!user) {
        alert("è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½å›å ±åƒ¹æ ¼å–”ï¼");
        location.href = "login.html";
        return;
    }

    document.getElementById("modalProductName").textContent =
        document.querySelector(".product-name").textContent;

    loadStoreOptions(); // â­â­â­ é—œéµ

    document.getElementById("reportModal").style.display = "flex";
}

// 2. é—œé–‰å½ˆçª—
function closeReportModal() {
    document.getElementById("reportModal").style.display = "none";
}

// 3. é€å‡ºå›å ±
async function submitReport() {
    const storeId = document.getElementById("reportStore").value;
    const price = document.getElementById("reportPrice").value;
    const user = getCurrentUser();

    if (!storeId || !price) {
        alert("è«‹å¡«å¯«åº—å®¶èˆ‡åƒ¹æ ¼");
        return;
    }

    try {
        await apiPost("/price-reports", {
            productId: productId,
            storeId: storeId,
            reportedPrice: parseFloat(price),
            userId: user.id
        });

        alert("å›å ±æˆåŠŸï¼ç­‰å¾…ç®¡ç†è€…å¯©æ ¸ ğŸ‘€");
        
        localStorage.removeItem(`priceHistory_${productId}`);

        closeReportModal();
        renderReportList(productId); // é‡æ–°æŠ“è³‡æ–™

    } catch (err) {
        alert(err.message || "å›å ±å¤±æ•—");
    }
}

function goCompare() {
    if (!getCurrentUser()) {
        alert("æŸ¥çœ‹æ¯”åƒ¹éœ€è¦å…ˆç™»å…¥æœƒå“¡å–”ï¼");
        location.href = "login.html";
        return;
    }
    location.href = `compare.html?id=${productId}`;
}

function goHistory() {
    if (!getCurrentUser()) {
        alert("æŸ¥çœ‹æ­·å²åƒ¹æ ¼éœ€è¦å…ˆç™»å…¥æœƒå“¡å–”ï¼");
        location.href = "login.html";
        return;
    }
    location.href = `history.html?productId=${productId}`;
}

if ("serviceWorker" in navigator) {
  	window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("/service-worker.js")
      .then(() => console.log("âœ… Service Worker å·²è¨»å†Š"))
      .catch(err => console.error("âŒ SW è¨»å†Šå¤±æ•—", err));
  	});
}
</script>
</body>
</html>
