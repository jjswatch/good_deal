<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GoodDealï½œå•†å“æ¯”åƒ¹å¹³å°</title>
<link rel="stylesheet" href="css/style.css" />
<!-- PWA è¨»å†Š -->
<link rel="manifest" href="manifest.json">
<style>
/* å•†å“å€å¡Š */
.product-header {
    max-width: 1100px;
    margin: 20px auto;
    padding: 20px;
    background: #fafafa;
    border-radius: 14px;
    display: flex;
    gap: 20px;
    align-items: center;
}

.product-header img {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 14px;
}

.product-info h2 {
    margin: 0;
}

.product-info p {
    margin: 4px 0;
    color: #666;
}

/* æ¯”åƒ¹æ¸…å–® */
#priceList {
    max-width: 1100px;
    margin: 20px auto;
}

.price-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: #fff;
    border-radius: 14px;
    border: 1px solid #eee;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 12px;
}

.price-store {
    font-size: 18px;
    font-weight: bold;
}

.price-value {
    font-size: 22px;
    font-weight: bold;
    color: #d62828;
}

.price-card a {
    padding: 8px 14px;
    background: black;
    color: white;
    border-radius: 8px;
    text-decoration: none;
}

.price-card a:hover {
    background: #333;
}


</style>
</head>

<body>



<!-- å•†å“åŸºæœ¬è³‡è¨Š -->
<div id="productBlock" class="product-header" style="display:none;">
    <img id="productImg" src="">
    <div class="product-info">
        <h2 id="productName"></h2>
        <p id="productBrand"></p>
        <p id="productSpec"></p>
    </div>
</div>

<!-- åƒ¹æ ¼åˆ—è¡¨ -->
<div id="priceList"></div>

<footer> Â© 2025 GoodDeal å•†å“æ¯”åƒ¹å¹³å°ï½œçœéŒ¢å°å¹«æ‰‹ </footer>



<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/components.js"></script>
<script>
if (!isLoggedIn()) {
	const goLogin = confirm("æ­¤åŠŸèƒ½éœ€è¦ç™»å…¥ï¼Œæ˜¯å¦å‰å¾€ç™»å…¥ï¼Ÿ");

	if (goLogin) {
		// æŠŠç›®å‰é é¢è¨˜èµ·ä¾†
	    const redirect = encodeURIComponent(location.href);
	    location.href = `login.html?redirect=${redirect}`;
	} else {
	    // å–æ¶ˆ â†’ å›ä¸Šä¸€é 
	    history.back();
	}
}

if ("serviceWorker" in navigator) {
	window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("/service-worker.js")
      .then(() => console.log("âœ… Service Worker å·²è¨»å†Š"))
      .catch(err => console.error("âŒ SW è¨»å†Šå¤±æ•—", err));
  	});
}

window.addEventListener("pageshow", () => {
    loadPrices();
});

const user = getCurrentUser();

function getQueryParam(name) {
    return new URLSearchParams(window.location.search).get(name);
}

async function loadProduct() {
    const id = getQueryParam("id");
    if (!id) return;

    const product = await apiGet(`/products/${id}`);

    if (!product) return;

    document.getElementById("productBlock").style.display = "flex";
    document.getElementById("productImg").src = product.imageUrl || "assets/placeholder.png";
    document.getElementById("productName").innerText = product.productName;
    document.getElementById("productBrand").innerText = product.brand ? "å“ç‰Œï¼š" + product.brand : "";
    document.getElementById("productSpec").innerText = product.spec ? "è¦æ ¼ï¼š" + product.spec : "";
}

async function loadPrices() {
    const id = getQueryParam("id");
    if (!id) return;

    const prices = await apiGet(`/prices/product/${id}`);
    const list = document.getElementById("priceList");

    if (!prices || prices.length === 0) {
        list.innerHTML = "<p style='text-align:center;color:#666;'>å°šç„¡æ¯”åƒ¹è³‡æ–™</p>";
        return;
    }

    prices.sort((a, b) => a.price - b.price);

    list.innerHTML = prices.map(p => `
    <div class="price-card">
        <div class="price-store">
            ${p.store.storeName}
            <div style="font-size:12px; color:#999; font-weight:normal;">å›å ±æ–¼ï¼š${p.updatedAt || 'ä»Šæ—¥'}</div>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="price-value">$${p.price}</div>
            <button onclick="addToWishlist('${id}', '${p.priceId}', '${p.store.storeName}', ${p.price})" style="background:none; border:none; cursor:pointer; padding:5px;"> ğŸ›’ </button>
        </div>
    </div>
`).join("");
}

function addToWishlist(productId, priceId, storeName, price) {
    const user = getCurrentUser();
    if (!user) {
        alert("è«‹å…ˆç™»å…¥å¾Œå†åŠ å…¥è³¼ç‰©æ¸…å–®å–”ï¼");
        return;
    }

    // å–å¾—ç›®å‰çš„å•†å“åŸºæœ¬è³‡è¨Š
    const productName = document.getElementById("productName").innerText;
    const productImg = document.getElementById("productImg").src;

    // å–å¾—ç¾æœ‰çš„æ¸…å–® (å¦‚æœæ²’æœ‰å°±å»ºç«‹ç©ºé™£åˆ—)
    let wishlist = JSON.parse(localStorage.getItem(`wishlist_${user.userId}`)) || [];

    // æª¢æŸ¥æ˜¯å¦é‡è¤‡åŠ å…¥
    if (wishlist.some(item => item.priceId === priceId)) {
        alert("é€™é …å•†å“åƒ¹æ ¼å·²ç¶“åœ¨æ¸…å–®ä¸­å›‰ï¼");
        return;
    }

    // åŠ å…¥æ–°é …ç›®
    const newItem = {
    	productId: parseInt(productId),
        priceId,
        productName,
        productImg,
        storeName,
        price,
        addedAt: new Date().toLocaleDateString()
    };

    wishlist.push(newItem);
    localStorage.setItem(`wishlist_${user.userId}`, JSON.stringify(wishlist));

    alert(`å·²å°‡ ${storeName} çš„åƒ¹æ ¼åŠ å…¥æ¸…å–®ï¼`);
    
    // é¸é …ï¼šåŠ å…¥å¾Œå¯ä»¥è·³è½‰åˆ°æ¸…å–®é ï¼Œæˆ–æ›´æ–° UI
}

// åˆå§‹åŒ–
loadProduct();
loadPrices();
</script>

</body>
</html>
