<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æœƒå“¡å€‹äººé é¢</title>
<link rel="stylesheet" href="css/style.css" />
<style>
.container {
	padding: 24px 16px 80px;
	max-width: 500px;
	margin: 0 auto;
}

.profile-header {
	text-align: center;
	margin-bottom: 30px;
	padding: 20px 0;
}

.avatar {
	width: 80px;
	height: 80px;
	background: #e2e8f0;
	border-radius: 50%;
	margin: 0 auto 10px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 32px;
}

.user-name {
	font-size: 20px;
	font-weight: 700;
	color: #1e293b;
	margin: 0;
}

.user-email {
	font-size: 14px;
	color: #64748b;
}

/* æ ¸å¿ƒå¡ç‰‡æ¨£å¼ */
.card {
	background: #fff;
	padding: 24px;
	margin-bottom: 20px;
	border-radius: 20px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
	border: 1px solid #f1f5f9;
	position: relative;
	overflow: hidden; /* å¿…å‚™ï¼Œè£åˆ‡è£é£¾åœ–ç¤º */
	transition: transform 0.2s;
	cursor: pointer;
}

.card:active {
	transform: scale(0.98);
}

/* è£é£¾ç”¨èƒŒæ™¯åœ–ç¤º (é€šç”¨å½å…ƒç´ ) */
.card::after {
	position: absolute;
	right: -15px;
	bottom: -15px;
	font-size: 90px;
	opacity: 0.06;
	transform: rotate(-15deg);
	pointer-events: none;
}

/* 1. è³£å ´å¡ç‰‡ç‰¹å®šæ¨£å¼ */
.store-entrance {
	background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
	border: 1px solid #ddd6fe !important;
}

.store-entrance::after {
	content: 'ğŸª';
}

.store-entrance h2 {
	color: #7c3aed;
}

.store-summary-text {
	color: #5b21b6;
}

/* 2. æœ€æ„›å¡ç‰‡ç‰¹å®šæ¨£å¼ */
.favorite-entrance {
	background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
	border: 1px solid #fed7aa !important;
}

.favorite-entrance::after {
	content: 'â¤ï¸';
}

.favorite-entrance h2 {
	color: #ea580c;
}

.favorite-summary-text {
	color: #9a3412;
}

/* 3. æ¸…å–®å¡ç‰‡ç‰¹å®šæ¨£å¼ */
.wishlist-entrance {
	background: linear-gradient(135deg, #fffcfb 0%, #fff5f2 100%);
	border: 1px solid #ffedd5 !important;
}

.wishlist-entrance::after {
	content: 'ğŸ›’';
}

.wishlist-entrance h2 {
	color: #ea580c;
}

.wishlist-summary-text {
	color: #9a3412;
}

.card h2 {
	margin: 0 0 10px 0;
	font-size: 19px;
	display: flex;
	align-items: center;
	gap: 10px;
	position: relative;
	z-index: 1;
}

.summary-desc {
	font-size: 14px;
	margin: 0;
	position: relative;
	z-index: 1;
	line-height: 1.5;
}

.wishlist-stats {
	padding: 2px 10px;
	border-radius: 20px;
	font-size: 12px;
	font-weight: bold;
	margin-left: auto;
	color: white;
}

#storeCountTag {
	background: #8b5cf6;
}

#favoriteCountTag, #wishlistCountTag {
	background: #ff7849;
}

.view-all-label {
	display: flex;
	align-items: center;
	justify-content: flex-end;
	font-weight: 700;
	font-size: 14px;
	margin-top: 15px;
	position: relative;
	z-index: 1;
}

.nav-title {
	font-size: 18px;
	font-weight: 700;
}
.points-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    color: white;
    border: none !important;
}
.points-card::after { content: 'ğŸª™'; opacity: 0.15 !important; }
.points-card h2 { color: #fcd34d !important; }
.points-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
}
.point-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
    border-radius: 12px;
    text-align: center;
}
.point-value { font-size: 18px; font-weight: 700; color: #fbbf24; }
.point-label { font-size: 12px; color: #cbd5e1; }
</style>
</head>
<body>

	<nav>
		<div class="nav-container">
			<span class="nav-title">å€‹äººé é¢</span>
			<div style="margin-left: auto;">
				<div class="nav-notification" onclick="location.href='setting.html'">âš™ï¸</div>
			</div>
		</div>
	</nav>

	<div class="container">
		<div class="profile-header">
			<div class="avatar">ğŸ‘¤</div>
			<h1 class="user-name" id="displayUserName">è¼‰å…¥ä¸­...</h1>
			<p class="user-email" id="displayUserEmail">---</p>
		</div>

		<div class="card points-card">
			<div style="display: flex; align-items: center;">
				<h2>æˆå°±ç­‰ç´š</h2>
				<span id="userLevelTag" class="wishlist-stats"
					style="background: #fbbf24; color: #1e293b;">LV.1</span>
			</div>
			<div class="points-grid">
				<div class="point-item">
					<div class="point-label">ç›®å‰é»æ•¸</div>
					<div class="point-value" id="displayPoints">0</div>
				</div>
				<div class="point-item">
					<div class="point-label">ä¿¡ç”¨è©•åˆ†</div>
					<div class="point-value" id="displayTrust">100.0</div>
				</div>
			</div>
		</div>

		<div class="card store-entrance"
			onclick="location.href='preferred-stores.html'">
			<div style="display: flex; align-items: center;">
				<h2>ğŸª å¸¸å»è³£å ´è¨­å®š</h2>
				<span id="storeCountTag" class="wishlist-stats"
					style="display: none;">0/3</span>
			</div>
			<p id="storeSummary" class="summary-desc store-summary-text">è¨­å®šæ‚¨æœ€å¸¸å»çš„
				3 é–“è³£å ´ï¼Œæ¯”åƒ¹æ›´ç²¾æº–</p>
			<div class="view-all-label" style="color: #7c3aed;">ç«‹å³è¨­å®š â†’</div>
		</div>

		<div class="card favorite-entrance"
			onclick="location.href='favorites.html'">
			<div style="display: flex; align-items: center;">
				<h2>â¤ï¸ æœ€æ„›</h2>
				<span id="favoriteCountTag" class="wishlist-stats"
					style="display: none;">0</span>
			</div>
			<p id="favoriteSummary" class="summary-desc favorite-summary-text">å°šæœªåŠ å…¥æœ€æ„›</p>
			<div class="view-all-label" style="color: #ea580c;">æŸ¥çœ‹å…¨éƒ¨ â†’</div>
		</div>

		<div class="card wishlist-entrance"
			onclick="location.href='wishlist.html'">
			<div style="display: flex; align-items: center;">
				<h2>ğŸ›’ è³¼ç‰©æ¸…å–®</h2>
				<span id="wishlistCountTag" class="wishlist-stats"
					style="display: none;">0</span>
			</div>
			<p id="wishlistSummary" class="summary-desc wishlist-summary-text">è¼‰å…¥æ¸…å–®ä¸­...</p>
			<div class="view-all-label" style="color: #ea580c;">å‰å¾€æ¡è²· â†’</div>
		</div>
	</div>

	<script src="js/auth.js"></script>
	<script src="js/api.js"></script>
	<script src="js/components.js"></script>
	<script>

async function init() {
    const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
    
    if (user) {
        loadWishlistSummary(user);
        
        try {
            const profile = await apiGet("/user/profile");
            if (profile) {
            	const uid = profile.userId;
            	loadProfile(profile);
                loadStoreSummary(uid);
                loadFavoriteSummary(uid);
                loadUserPoints(uid);
            }
        } catch (err) {
            console.warn("API é€£ç·šå¤±æ•—");
        }
    } else {
        // æœªç™»å…¥è™•ç†
        document.getElementById("wishlistSummary").innerText = "è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ¸…å–®";
    }
}

async function loadProfile(currentUser) {
    try {
        const user = await apiGet("/user/profile");
        if (user) {
            document.getElementById("displayUserName").innerText = user.username || "æœƒå“¡";
            document.getElementById("displayUserEmail").innerText = user.email || "";
            
            // æŠ“å–é ç«¯æ‘˜è¦
            loadStoreSummary(user.userId);
            loadFavoriteSummary(user.userId);
        }
    } catch (err) {
        console.warn("ç„¡æ³•å–å¾—æœ€æ–°å€‹äººè³‡è¨Š");
    }
}

async function loadUserPoints(userId) {
    try {
        const data = await apiGet(`/user-points/${userId}`);
        if (data) {
            document.getElementById("displayPoints").innerText = data.points.toLocaleString();
            document.getElementById("displayTrust").innerText = data.trustScore.toLocaleString();
            document.getElementById("userLevelTag").innerText = `LV.${data.level}`;
        }
    } catch (e) {
        console.error("ç„¡æ³•è¼‰å…¥é»æ•¸è³‡è¨Š");
    }
}

async function loadFavoriteSummary(userId) {
    try {
        const favorites = await apiGet(`/favorites/user/${userId}`);
        const summaryElement = document.getElementById("favoriteSummary");
        const tagElement = document.getElementById("favoriteCountTag");

        if (favorites && favorites.length > 0) {
            const count = favorites.length;
            const names = favorites.slice(0, 2).map(f => f.product.productName).join('ã€');
            const moreText = count > 2 ? `...ç­‰ ${count} ä»¶` : ` å…± ${count} ä»¶`;
            summaryElement.innerHTML = `ç›®å‰å·²æ”¶è—ï¼š<b>${names}${moreText}</b>`;
            tagElement.innerText = count;
            tagElement.style.display = "block";
        } else {
            summaryElement.innerText = "å°šæœªåŠ å…¥ä»»ä½•æœ€æ„›å•†å“";
            tagElement.style.display = "none";
        }
    } catch (e) {
        summaryElement.innerText = "ç„¡æ³•è¼‰å…¥æ”¶è—è³‡è¨Š";
    }
}

async function loadStoreSummary(userId) {
    try {
        const stores = await apiGet(`/user/preferred-stores/${userId}`);
        if (stores && stores.length > 0) {
            document.getElementById("storeSummary").innerHTML = 
                `ç›®å‰è¨­å®šï¼š<b>${stores.map(s => s.store.storeName).join('ã€')}</b>`;
            const tag = document.getElementById("storeCountTag");
            tag.innerText = `${stores.length}/3`;
            tag.style.display = "block";
        }
    } catch (e) { console.error("ç„¡æ³•è¼‰å…¥è³£å ´æ‘˜è¦"); }
}

function loadWishlistSummary(user) {
    const uid = user.userId || user.id;
    const wishlist = JSON.parse(localStorage.getItem(`wishlist_${uid}`)) || [];
    const count = wishlist.length;
    const total = wishlist.reduce((sum, item) => sum + (item.price || 0), 0); 
    
    document.getElementById("wishlistSummary").innerHTML = count > 0 
        ? `ç›®å‰å·²å­˜ <b>${count}</b> ç­†å„ªæƒ ï¼Œé è¨ˆèŠ±è²» <b>$${total}</b>` 
        : "ç›®å‰é‚„æ²’æœ‰æƒ³è²·çš„å•†å“ï¼Œå¿«å»æœå°‹æ¯”åƒ¹å§ï¼";
    
    if (count > 0) {
        const tag = document.getElementById("wishlistCountTag");
        tag.innerText = count;
        tag.style.display = "block";
    }
}

function handleLogout() {
    if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        location.href = "login.html";
    }
}

init();
</script>
</body>
</html>