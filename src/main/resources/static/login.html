<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GoodDeal｜登入</title>
<link rel="stylesheet" href="css/style.css" />
<style>
/* Hero */
.hero {
	background: #f7f7f7;
	padding: 24px 20px;
	text-align: center;
}

.hero h2 {
	margin: 0;
	font-size: 24px;
}

/* Main */
.main {
	max-width: 420px;
	margin: 60px auto;
	padding: 0 20px;
}

.main h2 {
	text-align: center;
	margin-bottom: 24px;
}

/* Form */
.form-group {
	margin-bottom: 16px;
}

.form-group label {
	display: block;
	margin-bottom: 6px;
	font-size: 14px;
	color: #555;
}

.form-group input {
	width: 100%;
	padding: 12px;
	border-radius: 10px;
	border: 1px solid #ddd;
	font-size: 15px;
	box-sizing: border-box;
}

.form-group input:focus {
	outline: none;
	border-color: #999;
}

/* Button */
button {
	width: 100%;
	padding: 14px;
	border-radius: 12px;
	border: none;
	background: #111;
	color: #fff;
	font-size: 16px;
	cursor: pointer;
}

button:hover {
	background: #333;
}

/* Extra */
.extra {
	text-align: center;
	margin-top: 16px;
	font-size: 14px;
	color: #777;
}

.extra a {
	color: #111;
	text-decoration: none;
	font-weight: bold;
}

.extra a:hover {
	text-decoration: underline;
}
</style>
</head>

<body>

<nav>
	<div class="nav-container">
		<div class="logo" onclick="location.href='index.html'">GoodDeal</div>
	</div>
</nav>

<section class="hero">
	<h2>會員登入</h2>
</section>

<main class="main">
	<div class="form-group">
		<label for="username">帳號</label>
		<input type="text" id="username" placeholder="請輸入帳號">
	</div>

	<div class="form-group">
		<label for="password">密碼</label>
		<input type="password" id="password" placeholder="請輸入密碼">
	</div>
	
	<div id="loginError" style="display:none; margin-bottom:12px; padding:10px; border-radius:10px; background:#fdecea; color:#b71c1c; font-size:14px; text-align:center;"></div>

	<button onclick="login()">登入</button>

	<div class="extra">
		還沒有帳號？
		<a href="register.html">立即註冊</a>
	</div>
</main>

<script src="js/api.js"></script>
<script>
async function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorBox = document.getElementById("loginError");

  errorBox.style.display = "none";
  errorBox.textContent = "";

  if (!username || !password) {
    errorBox.textContent = "請輸入帳號與密碼";
    errorBox.style.display = "block";
    return;
  }

  try {
	// ① 先嘗試使用者登入
	    let res;
	    try {
	      res = await apiPostPublic("/auth/login", { username, password });
	    } catch {
	      // ② 使用者失敗 → 嘗試管理員登入
	      res = await apiPostPublic("/admin/login", { username, password });
	    }

	    // ③ 存 JWT
	    localStorage.setItem("token", res.token);

	    // ④ 解 JWT 取得角色（或後端直接回 role）
	    const payload = JSON.parse(atob(res.token.split(".")[1]));
	    const role = payload.role;

	    localStorage.setItem("role", role);
	    localStorage.setItem("username", payload.sub);

	    // ⑤ 依角色導向
	    if (role === "ADMIN") {
	      location.href = "admin/admin-dashboard.html";
	    } else {
	      location.href = "index.html";
	    }

	  } catch (err) {
	    errorBox.textContent = "帳號或密碼錯誤";
	    errorBox.style.display = "block";
	  }
}
</script>


</body>
</html>
