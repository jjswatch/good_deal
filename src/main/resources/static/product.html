<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GoodDealï½œå•†å“æ¯”åƒ¹å¹³å°</title>
<link rel="stylesheet" href="css/style.css" />
<!-- PWA è¨»å†Š -->
<link rel="manifest" href="manifest.json">

<style>

/* å•†å“å¡ç‰‡ */
#productInfo {
	max-width: 1100px;
	margin: 20px auto;
	background: white;
	border-radius: 14px;
	padding: 20px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
	text-align: center;
}

#productInfo img {
	width: 180px;
	height: 180px;
	object-fit: cover;
	border-radius: 10px;
	margin-bottom: 16px;
}

.product-name {
	font-size: 22px;
	margin-bottom: 10px;
	font-weight: bold;
}

.product-desc {
	font-size: 15px;
	color: #555;
	margin-bottom: 20px;
	line-height: 1.6;
}

/* æœ€ä½åƒ¹å¡ç‰‡å®¹å™¨ */
.price-summary {
    display: inline-block;
    background: #f8fafc;
    border: 1.5px dashed #cbd5e1;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    width: 100%;
    max-width: 400px;
    text-align: left;
}

.price-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.price-item:last-child { margin-bottom: 0; }

.label-pill {
    background: #e2e8f0;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    color: #475569;
    font-weight: 600;
}

.price-item.history .label-pill {
    background: #fee2e2;
    color: #ef4444;
}

.price-value {
    font-size: 24px;
    font-weight: 800;
    color: #1e293b;
}

.store-name {
    display: block;
    font-size: 12px;
    color: #94a3b8;
    text-align: right;
}

.price-hint {
    margin-top: 15px;
    padding-top: 12px;
    border-top: 1px solid #e2e8f0;
    font-size: 14px;
    font-weight: 600;
    color: #059669; /* é è¨­ç¶ è‰² (å»ºè­°å…¥æ‰‹) */
    text-align: center;
}

/* å”¯ä¸€çš„æœ€ä½åƒ¹æ¨™ç±¤æ¨£å¼ */
.best-price-card {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 15px 30px;
    margin: 20px 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.best-price-label {
    font-size: 13px;
    font-weight: 700;
    padding: 4px 12px;
    border-radius: 50px;
    margin-bottom: 8px;
    text-transform: uppercase;
}

/* æ­·å²æœ€ä½ï¼šé‡‘ç´…è‰²èª¿ */
.label-history {
    background: #fee2e2;
    color: #ef4444;
    border: 1px solid #fecaca;
}

/* è¿‘æœŸæœ€ä½ï¼šè—è‰²èª¿ */
.label-recent {
    background: #dbeafe;
    color: #2563eb;
    border: 1px solid #bfdbfe;
}

.best-price-value {
    font-size: 32px;
    font-weight: 900;
    color: #1e293b;
    line-height: 1;
}

.best-price-store {
    font-size: 14px;
    color: #64748b;
    margin-top: 5px;
}

/* æŒ‰éˆ•çµ±ä¸€æ¨£å¼ */
a.button {
	display: inline-block;
	padding: 12px 20px;
	background: black;
	color: white;
	border-radius: 10px;
	text-decoration: none;
	font-size: 16px;
	margin: 10px;
	transition: 0.2s;
}

a.button:hover {
	background: #333;
}

.report-item {
    background: #fff;
    border: 1px solid #edf2f7;
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.report-user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 32px;
    height: 32px;
    background: #e2e8f0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #64748b;
}

.report-details {
    font-size: 14px;
}

.report-store-tag {
    font-size: 11px;
    background: #f1f5f9;
    color: #475569;
    padding: 2px 8px;
    border-radius: 4px;
    margin-right: 5px;
}

.report-price {
    font-weight: 700;
    color: #ef4444;
}

.report-time {
    font-size: 12px;
    color: #94a3b8;
}
</style>
</head>

<body>


<div id="productInfo">
	<!-- JS å‹•æ…‹æ³¨å…¥å…§å®¹ã€‚ä¾‹å¦‚ï¼š
    <img src="...">
    <div class="product-name">å•†å“åç¨±</div>
    <div class="product-desc">æè¿°å…§å®¹</div>
    -->
</div>

<div style="text-align: center; margin-top: 10px;">
    <button onclick="openReportModal()" style="background: #FF4500; border: none;" class="button">
        ğŸ“¢ æˆ‘è¦å›å ±æ–°åƒ¹æ ¼
    </button>
</div>

<div id="reportModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:25px; border-radius:16px; width:90%; max-width:400px; position:relative;">
        <h3>å›å ±å•†å“åƒ¹æ ¼</h3>
        <p id="modalProductName" style="color:#666; font-size:14px;"></p>
        
        <div style="margin-bottom:15px; text-align:left;">
            <label style="display:block; margin-bottom:5px;">é€šè·¯åº—å®¶</label>
            <select id="reportStore" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
    			<option value="">è«‹é¸æ“‡åº—å®¶</option>
			</select>
        </div>

        <div style="margin-bottom:20px; text-align:left;">
            <label style="display:block; margin-bottom:5px;">å›å ±åƒ¹æ ¼ ($)</label>
            <input type="number" id="reportPrice" placeholder="è«‹è¼¸å…¥çœ‹åˆ°çš„åƒ¹æ ¼" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box;">
        </div>

        <button onclick="submitReport()" style="width:100%; background:#FF4500;" class="button">é€å‡ºå›å ±</button>
        <button onclick="closeReportModal()" style="width:100%; background:#999;" class="button">å–æ¶ˆ</button>
    </div>
</div>

<div class="report-section" style="max-width: 1100px; margin: 30px auto; padding: 0 20px; text-align: left;">
    <h3 style="font-size: 18px; border-left: 4px solid #FF4500; padding-left: 10px; margin-bottom: 15px;">
        æœ€æ–°æœƒå“¡å›å ±åƒ¹æ ¼
    </h3>
    <ul id="reportList" style="list-style: none; padding: 0;">
        <li style="color: #94a3b8; text-align: center; padding: 20px;">è¼‰å…¥å›å ±ç´€éŒ„ä¸­...</li>
    </ul>
</div>

<div style="text-align: center;">
	<a id="compareBtn" class="button" onclick="goCompare()">æŸ¥çœ‹æ¯”åƒ¹</a> <a id="historyBtn" class="button" onclick="goHistory()">æŸ¥çœ‹æ­·å²åƒ¹æ ¼</a>
</div>

<footer> Â© 2025 GoodDeal å•†å“æ¯”åƒ¹å¹³å°ï½œçœéŒ¢å°å¹«æ‰‹ </footer>


<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/components.js"></script>
<script>
const params = new URLSearchParams(window.location.search);
const productId = params.get("id");

if (productId) {
    initProductPage(productId);
}

async function initProductPage(id) {
    try {
        // 1. åŒæ™‚ç²å–å•†å“è³‡è¨Šèˆ‡åƒ¹æ ¼æ•¸æ“š (ä¸¦è¡Œè«‹æ±‚æ•ˆèƒ½æ›´å¥½)
        const [product, prices] = await Promise.all([
        	apiGetPublic(`/products/${id}`),
        	apiGetPublic(`/products/${id}/price-lowest`)
        ]);

        renderProductBasic(product);
        renderPriceSummary(prices);
        renderReportList(id);
    } catch (err) {
        console.error("è¼‰å…¥å¤±æ•—", err);
    }
}

async function loadStoreOptions() {
    const select = document.getElementById("reportStore");
    select.innerHTML = `<option value="">è«‹é¸æ“‡åº—å®¶</option>`;

    try {
        const stores = await apiGetPublic("/stores");

        stores.forEach(store => {
            const opt = document.createElement("option");
            opt.value = store.storeId;          // â­ ä¸€å®šæ˜¯ ID
            opt.textContent = store.storeName;
            select.appendChild(opt);
        });

    } catch (err) {
        console.error("è¼‰å…¥åº—å®¶å¤±æ•—", err);
        select.innerHTML = `<option value="">ç„¡æ³•è¼‰å…¥åº—å®¶</option>`;
    }
}

async function renderReportList(productId) {
    const listContainer = document.getElementById("reportList");
    listContainer.innerHTML = `<li style="color:#94a3b8; text-align:center;">è¼‰å…¥ä¸­...</li>`;

    try {
        const reports = await apiGetPublic(
            `/price-reports/product/${productId}?limit=5`
        );

        if (!reports || reports.length === 0) {
            listContainer.innerHTML = `
                <li style="color:#94a3b8; text-align:center;">
                    å°šç„¡æœƒå“¡å›å ±åƒ¹æ ¼
                </li>`;
            return;
        }

        listContainer.innerHTML = reports.map(r => `
            <li class="report-item">
                <div class="report-user-info">
                    <div class="user-avatar">
                        ${(r.userName || "U").charAt(0)} 
                    </div>
                    <div class="report-details">
                        <span class="report-store-tag">${r.storeName}</span>
                        <strong>${r.userName}</strong> å›å ±
                        <span class="report-price">$${r.price}</span>
                    </div>
                </div>
                <div class="report-time">
                    ${formatTimeAgo(r.date)}
                </div>
            </li>
        `).join("");

    } catch (err) {
        console.error("æ¸²æŸ“æ¸…å–®å¤±æ•—:", err);
        listContainer.innerHTML = `
            <li style="color:#ef4444; text-align:center;">
                å›å ±ç´€éŒ„è¼‰å…¥å¤±æ•—
            </li>`;
    }
}

function formatTimeAgo(time) {
    const diff = (Date.now() - new Date(time)) / 1000;
    if (diff < 60) return "å‰›å‰›";
    if (diff < 3600) return `${Math.floor(diff / 60)} åˆ†é˜å‰`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} å°æ™‚å‰`;
    return `${Math.floor(diff / 86400)} å¤©å‰`;
}

function renderProductBasic(p) {
    document.getElementById("productInfo").innerHTML = `
        <h2 class="product-name">${p.brand} ${p.productName}</h2>
        <img src="${p.imageUrl || 'assets/placeholder.png'}" alt="${p.productName}">
        <div id="price-container"></div> <p class="product-desc">${p.description || "ç„¡å•†å“ä»‹ç´¹"}</p>
        <div style="color: #64748b; font-size: 14px;">
            <p>è¦æ ¼ï¼š${p.spec}</p>
            <p>æ¢ç¢¼ï¼š${p.barcode}</p>
        </div>
    `;
    
    // æ›´æ–°ä¸‹æ–¹æŒ‰éˆ•é€£çµ
    document.getElementById("compareBtn").href = `compare.html?id=${p.productId}`;
    document.getElementById("historyBtn").href = `history.html?productId=${p.productId}`;
}

function renderPriceSummary(data) {
    const container = document.getElementById("price-container");
    const history = data.historical;
    const recent = data.recent30Days;

    if (!history && !recent) {
        container.innerHTML = `<p style="color:#94a3b8">ç›®å‰æš«ç„¡åƒ¹æ ¼ç´€éŒ„</p>`;
        return;
    }

    // æ±ºå®šé¡¯ç¤ºå“ªä¸€ç­†è³‡æ–™çš„é‚è¼¯
    let displayData = null;
    let labelText = "";
    let labelClass = "";

    // å¦‚æœ 30å¤©æœ€ä½æ¯”æ­·å²æœ€ä½é‚„é«˜ï¼Œæˆ–è€…æ ¹æœ¬æ²’æœ‰30å¤©è³‡æ–™ï¼Œå°±é¡¯ç¤ºæ­·å²æœ€ä½
    if (!recent || (history && history.price <= recent.price)) {
        displayData = history;
        labelText = "ğŸ† å›å ±æœ€ä½åƒ¹";
        labelClass = "label-history";
    } else {
        // å¦å‰‡é¡¯ç¤ºè¿‘æœŸæœ€ä½ (ä»£è¡¨æœ€è¿‘çœŸçš„æœ‰æ„Ÿé™åƒ¹)
        displayData = recent;
        labelText = "âš¡ è¿‘ 30 å¤©æœ€ä½";
        labelClass = "label-recent";
    }

    container.innerHTML = `
        <div class="best-price-card">
            <span class="best-price-label ${labelClass}">${labelText}</span>
            <div class="best-price-value">$${displayData.price}</div>
        </div>
    `;
}

//1. é–‹å•Ÿå½ˆçª—
function openReportModal() {
    const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
    if (!user) {
        alert("è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½å›å ±åƒ¹æ ¼å–”ï¼");
        location.href = "login.html";
        return;
    }

    document.getElementById("modalProductName").textContent =
        document.querySelector(".product-name").textContent;

    loadStoreOptions(); // â­â­â­ é—œéµ

    document.getElementById("reportModal").style.display = "flex";
}

// 2. é—œé–‰å½ˆçª—
function closeReportModal() {
    document.getElementById("reportModal").style.display = "none";
}

// 3. é€å‡ºå›å ±
async function submitReport() {
    const storeId = document.getElementById("reportStore").value;
    const price = document.getElementById("reportPrice").value;
    const user = getCurrentUser();

    if (!storeId || !price) {
        alert("è«‹å¡«å¯«åº—å®¶èˆ‡åƒ¹æ ¼");
        return;
    }

    try {
        await apiPost("/price-reports", {
            productId: productId,
            storeId: storeId,
            reportedPrice: parseFloat(price),
            userId: user.id
        });

        alert("å›å ±æˆåŠŸï¼ç­‰å¾…ç®¡ç†è€…å¯©æ ¸ ğŸ‘€");

        closeReportModal();
        renderReportList(productId); // é‡æ–°æŠ“è³‡æ–™

    } catch (err) {
        alert(err.message || "å›å ±å¤±æ•—");
    }
}

function goCompare() {
    if (!getCurrentUser()) {
        alert("æŸ¥çœ‹æ¯”åƒ¹éœ€è¦å…ˆç™»å…¥æœƒå“¡å–”ï¼");
        location.href = "login.html";
        return;
    }
    location.href = `compare.html?id=${productId}`;
}

function goHistory() {
    if (!getCurrentUser()) {
        alert("æŸ¥çœ‹æ­·å²åƒ¹æ ¼éœ€è¦å…ˆç™»å…¥æœƒå“¡å–”ï¼");
        location.href = "login.html";
        return;
    }
    location.href = `history.html?productId=${productId}`;
}

if ("serviceWorker" in navigator) {
  	window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("/service-worker.js")
      .then(() => console.log("âœ… Service Worker å·²è¨»å†Š"))
      .catch(err => console.error("âŒ SW è¨»å†Šå¤±æ•—", err));
  	});
}


</script>

</body>
</html>
