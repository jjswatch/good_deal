<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æˆ‘çš„è³¼ç‰©æ¸…å–®ï½œGoodDeal</title>
<link rel="stylesheet" href="css/style.css" />
<style>
.analysis-dashboard {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: white;
    padding: 24px;
    border-radius: 20px;
    margin-bottom: 30px;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
}
.analysis-dashboard::after {
    content: "";
    position: absolute;
    top: -50px;
    right: -50px;
    width: 150px;
    height: 150px;
    background: rgba(251, 191, 36, 0.1);
    filter: blur(50px);
    border-radius: 50%;
}
.strategy-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-top: 18px;
}
.strategy-card {
    background: rgba(255, 255, 255, 0.05);
    padding: 16px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.2s, background 0.2s;
    display: flex;
    flex-direction: column;
}
.strategy-card:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-2px);
}
.strategy-label {
    font-size: 12px;
    font-weight: 600;
    color: #94a3b8;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.strategy-price {
    font-size: 24px;
    font-weight: 800;
    color: #fbbf24;
    margin: 4px 0;
}
.strategy-desc {
    font-size: 12px; /* ç¨å¾®æ”¾å¤§ä¸€é» */
    color: #94a3b8;
    line-height: 1.5;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1); /* åŠ ä¸€æ¢åˆ†éš”ç·š */
}
.strategy-desc div span {
    color: #fbbf24;
    font-weight: 600;
}
.best-mix {
    border: 2px solid #fbbf24 !important;
    background: rgba(251, 191, 36, 0.1) !important;
    box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
}

/* æœ€ä½³åº—å®¶çš„å°çš‡å† åœ–ç¤º (ç”¨ CSS ç¹ªè£½) */
.best-store-highlight::before {
    content: "ğŸ‘‘";
    font-size: 14px;
    margin-right: 4px;
}

/* è³¼ç‰©æ¸…å–®ä¸­çš„åº—å®¶æ¨™é¡Œå„ªåŒ– */
.store-header {
    background: #f8fafc;
    padding: 12px 16px;
    border-radius: 12px 12px 0 0;
    border-left: 4px solid #1e293b;
}

.container {
	padding: 20px 16px;
	max-width: 600px;
	margin: 0 auto;
	padding-bottom: 100px;
}

/* åº—å®¶å€å¡Š */
.store-group {
	margin-bottom: 25px;
}

.store-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 10px 0;
	border-bottom: 2px solid var(--primary-color);
	margin-bottom: 12px;
}

.store-name {
	font-size: 18px;
	font-weight: 800;
	color: #1e293b;
}

.store-subtotal {
	font-size: 14px;
	color: #64748b;
}

/* å•†å“å¡ç‰‡å„ªåŒ– */
.wish-item {
	display: flex;
	align-items: center;
	background: white;
	padding: 12px;
	border-radius: 12px;
	margin-bottom: 10px;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
	transition: opacity 0.3s;
}

.wish-item.checked {
	opacity: 0.5;
	text-decoration: line-through;
}

.wish-item img {
	width: 60px;
	height: 60px;
	border-radius: 8px;
	object-fit: cover;
}

.wish-info {
	flex: 1;
	margin-left: 15px;
}

.wish-title {
	font-weight: 600;
	font-size: 15px;
	margin-bottom: 4px;
}

.wish-price {
	color: #ef4444;
	font-weight: 700;
	font-size: 16px;
}

/* å‹¾é¸æ¡†æ¨£å¼ */
.check-btn {
	width: 24px;
	height: 24px;
	border: 2px solid #cbd5e1;
	border-radius: 50%;
	margin-right: 12px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
}

.checked .check-btn {
	background: #059669;
	border-color: #059669;
	color: white;
}

/* åº•éƒ¨çµç®—æ¬„ */
.summary-bar {
	position: fixed;
	bottom: 70px;
	left: 0;
	right: 0;
	background: #1e293b;
	color: white;
	padding: 15px 20px;
	display: flex;
	justify-content: space-between;
	align-items: center;
	z-index: 100;
}

.total-label {
	font-size: 14px;
	opacity: 0.8;
}

.total-amount {
	font-size: 20px;
	font-weight: 800;
	color: #fbbf24;
}

.empty-state {
	text-align: center;
	padding: 50px 20px;
	color: #94a3b8;
}
.brand-label {
    color: #64748b; /* å†·ç°è‰² */
    font-weight: 500;
    margin-right: 4px;
    font-size: 0.9em;
}
.wish-item.checked .brand-label {
    color: #cbd5e1;
    text-decoration: line-through;
}
</style>
</head>
<body>
<nav>
	<div class="nav-container">
		<div style="margin-left: auto; display: flex; align-items: center;">
			<div class="nav-notification" onclick="location.href='setting.html'">
				<svg class="nav-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
	            <div class="notification-dot" id="notiDot"></div>
	        </div>
	    </div>
	</div>
</nav>
<div class="analysis-dashboard" id="comparisonDashboard">
    <h3 style="margin-top:0; font-size:16px;">ğŸ’¡ æ¡è²·ç­–ç•¥åˆ†æ</h3>
    <div class="strategy-grid">
        <div class="strategy-card best-mix">
            <div class="strategy-label">æœ€çœçµ„åˆ (åˆ†é–‹è²·)</div>
            <div class="strategy-price" id="mixPrice">$0</div>
            <div class="strategy-desc" id="splitDetail"></div>
        </div>
        <div class="strategy-card best-store">
            <div class="strategy-label" id="bestStoreName">æœ€ä½³å–®ä¸€åº—å®¶</div>
            <div class="strategy-price" id="bestStorePrice">$0</div>
            <div class="strategy-desc" id="bestStoreDesc">ä¸€ç«™å¼è³¼è¶³æœ€æ–¹ä¾¿</div>
        </div>
    </div>
</div>

<div class="container">
	<div id="wishlistContent"></div>
</div>

<div class="summary-bar" id="summaryBar" style="display: none;">
	<div>
		<span class="total-label">é è¨ˆæ¡è²·ç¸½é¡</span>
		<div class="total-amount" id="grandTotal">$0</div>
	</div>
	<button onclick="clearChecked()" style="background: #475569; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 12px;">æ¸…é™¤å·²è³¼é …ç›®</button>
</div>

<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/components.js"></script>
<script>
async function calculateBestStrategy(wishlist) {
    const productIds = wishlist.map(item => item.productId);
    if (productIds.length === 0) {
        document.getElementById("comparisonDashboard").style.display = "none";
        return;
    }

    document.getElementById("bestStoreDesc").innerText = "æ­£åœ¨åˆ†ææœ€ä½³æ¡è²·ç­–ç•¥...";

    try {
        const res = await apiGet(
            `/strategies/compare-basket?ids=${productIds.join(',')}`
        );

        renderStrategyDashboard(res);

    } catch (err) {
    	console.error("ç­–ç•¥åˆ†æå¤±æ•—", err);
        document.getElementById("comparisonDashboard").style.display = "none";
    }
}

function renderStrategyDashboard(data) {
    const dashboard = document.getElementById("comparisonDashboard");
    dashboard.style.display = "block";

    /* ========= æ‹†å–®ç­–ç•¥ ========= */
    const split = data?.splitStrategy;

if (split?.total != null) {
    document.getElementById("mixPrice").innerText = `$${split.total}`;

    const detailEl = document.getElementById("splitDetail");

    const grouped = split.items.reduce((acc, item) => {
        if (!acc[item.storeName]) acc[item.storeName] = [];
        acc[item.storeName].push(item);
        return acc;
    }, {});

    detailEl.innerHTML = Object.entries(grouped).map(([store, items]) => `
    <div style="margin-bottom:12px;">
        <div style="font-weight:700; color:#fbbf24; margin-bottom:4px;">
            ğŸ“ ${store}
        </div>
        ${items.map(i => `
            <div style="padding-left:10px; font-size:12px;">
                - ${i.brand} ${i.productName}
                <span style="float:right;">$${i.price}</span>
            </div>
        `).join("")}
    </div>
`).join("");
} else {
	document.getElementById("mixPrice").innerText = "--";
    document.getElementById("splitDetail").innerText = "ç„¡æ‹†å–®å»ºè­°";
}

    /* ========= ä¸€ç«™è³¼é½Šç­–ç•¥ ========= */
    const storePriceEl = document.getElementById("bestStorePrice");
    const storeNameEl = document.getElementById("bestStoreName");
    const descEl = document.getElementById("bestStoreDesc");

    if (data?.bestStore) {
        storePriceEl.innerText = `$${data.bestStore.total}`;
        storeNameEl.innerHTML =
            `<span class="best-store-highlight">ğŸ“ ${data.bestStore.storeName}</span>`;
            
            if (
            	    data?.bestStore &&
            	    data.bestStore.coveredCount < data.bestStore.totalCount &&
            	    Array.isArray(data.bestStore.missingItems) &&
            	    data.bestStore.missingItems.length > 0
            	) {
            	    // ğŸ‘‰ é¡¯ç¤ºç¼ºå°‘å•†å“ï¼ˆå„ªå…ˆï¼‰
            	    descEl.innerHTML = `
            	        âŒ ç¼ºå°‘ ${data.bestStore.totalCount - data.bestStore.coveredCount} é …å•†å“<br>
            	        <span style="font-size:11px;">
            	            ç¼ºå°‘ï¼š${data.bestStore.missingItems.join("ã€")}
            	        </span>
            	    `;
            	} else {
            	    // ğŸ‘‰ æ²’ç¼ºæ‰é¡¯ç¤ºæ¨è–¦ç†ç”±
            	    descEl.innerText = data?.recommendation || "ä¸€ç«™å¼è³¼è¶³æœ€æ–¹ä¾¿";
            	}
    }

    descEl.style.color = "#fbbf24";

    /* ========= é«˜äº®æ¨è–¦ ========= */
    highlightRecommend(
        data?.bestStore ? "ONE_STORE" : "SPLIT"
    );
}



function highlightRecommend(type) {
    const mixCard = document.querySelector(".strategy-card.best-mix");
    const storeCard = document.querySelector(".strategy-card.best-store");

    mixCard.classList.remove("best-mix");
    storeCard.classList.remove("best-mix");

    if (type === "SPLIT") {
        mixCard.classList.add("best-mix");
    } else if (type === "ONE_STORE") {
        storeCard.classList.add("best-mix");
    }
    // å…¶ä»–æƒ…æ³ä¸é«˜äº®ï¼ˆä¾‹å¦‚è³‡æ–™ä¸è¶³ï¼‰
}

document.addEventListener("DOMContentLoaded", () => {
	renderWishlist();
});

function renderWishlist() {
	const user = getCurrentUser();
    if (!user) {
        location.href = "login.html";
        return;
    }

    const uid = user.userId || user.id;
    const wishlist = JSON.parse(localStorage.getItem(`wishlist_${uid}`)) || [];
    const container = document.getElementById("wishlistContent");
        
    if (wishlist.length === 0) {
        container.innerHTML = `
        	<div class="empty-state">
            	<div style="font-size: 50px;">ğŸ›’</div>
                <h3>æ¸…å–®ç›®å‰æ˜¯ç©ºçš„</h3>
                <p>åœ¨æ¯”åƒ¹æ™‚é»æ“Šæ„›å¿ƒï¼ŒæŠŠåˆ’ç®—çš„å•†å“å­˜ä¸‹ä¾†å§ï¼</p>
                <a href="index.html" class="button" style="display:inline-block; margin-top:20px; background:var(--primary-color);">å»é€›é€›</a>
            </div>`;
        document.getElementById("summaryBar").style.display = "none";
        document.getElementById("comparisonDashboard").style.display = "none";
        return;
    }

    // 1. æŒ‰åº—å®¶åˆ†çµ„è³‡æ–™
    const groups = wishlist.reduce((acc, item) => {
        if (!acc[item.storeName]) acc[item.storeName] = [];
        acc[item.storeName].push(item);
        return acc;
    }, {});

    // 2. æ¸²æŸ“ HTML
    let html = "";
    let grandTotal = 0;

    for (const storeName in groups) {
        const items = groups[storeName];
        const subtotal = items
        .filter(i => !i.checked) 
        .reduce((sum, i) => sum + i.price, 0);
        grandTotal += subtotal;

        html += `
            <div class="store-group">
                <div class="store-header">
                    <span class="store-name">ğŸ“ ${storeName}</span>
                    <span class="store-subtotal">å…± ${items.length} é …, å°è¨ˆ $${subtotal}</span>
                </div>
                ${items.map((item, idx) => `
                    <div class="wish-item ${item.checked ? 'checked' : ''}" id="item-${item.priceId}">
                        <div class="check-btn" onclick="toggleCheck('${item.priceId}')">${item.checked ? 'âœ“' : ''}</div>
                        <img src="${item.productImg}" alt="">
                        <div class="wish-info">
                            <div class="wish-title">
                                ${item.brand ? `<span class="brand-label">${item.brand}</span>` : ''} 
                                ${item.productName}
                            </div>
                            <div class="wish-price">$${item.price}</div>
                        </div>
                        <button onclick="removeItem('${item.priceId}')" style="background:none; border:none; color:#cbd5e1; font-size:18px;">âœ•</button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    container.innerHTML = html;
    document.getElementById("grandTotal").innerText = `$${grandTotal}`;
    document.getElementById("summaryBar").style.display = "flex";

    calculateBestStrategy(wishlist);
}

// å‹¾é¸åŠŸèƒ½ (æ¨¡æ“¬æ”¾å…¥è³¼ç‰©è»Š)
function toggleCheck(priceId) {
	const user = getCurrentUser();
	if (!user) return;
	const uid = user.userId || user.id;
	let wishlist = JSON.parse(localStorage.getItem(`wishlist_${uid}`));
    const index = wishlist.findIndex(i => i.priceId === priceId);
    if (index !== -1) {
    	wishlist[index].checked = !wishlist[index].checked;
    	localStorage.setItem(`wishlist_${uid}`, JSON.stringify(wishlist));
        renderWishlist();
    }
}

// ç§»é™¤å–®ä¸€é …ç›®
function removeItem(priceId) {
	if (!confirm("ç¢ºå®šè¦å¾æ¸…å–®ç§»é™¤å—ï¼Ÿ")) return;
    const user = getCurrentUser();
    if (!user) return;
    const uid = user.userId || user.id;
    let wishlist = JSON.parse(localStorage.getItem(`wishlist_${uid}`));
    wishlist = wishlist.filter(i => i.priceId !== priceId);
    localStorage.setItem(`wishlist_${uid}`, JSON.stringify(wishlist));
    renderWishlist();
}

// æ¸…é™¤æ‰€æœ‰å·²å‹¾é¸é …ç›® (æ¡è²·å®Œç•¢)
function clearChecked() {
	const user = getCurrentUser();
	if (!user) return;
	const uid = user.userId || user.id;
    let wishlist = JSON.parse(localStorage.getItem(`wishlist_${uid}`));
    wishlist = wishlist.filter(i => !i.checked);
    localStorage.setItem(`wishlist_${uid}`, JSON.stringify(wishlist));
    renderWishlist();
}
</script>

</body>
</html>