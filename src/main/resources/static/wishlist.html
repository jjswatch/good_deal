<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„è³¼ç‰©æ¸…å–®ï½œGoodDeal</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
        .container { padding: 20px 16px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        
        /* åº—å®¶å€å¡Š */
        .store-group { margin-bottom: 25px; }
        .store-header { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 2px solid var(--primary-color); margin-bottom: 12px;
        }
        .store-name { font-size: 18px; font-weight: 800; color: #1e293b; }
        .store-subtotal { font-size: 14px; color: #64748b; }

        /* å•†å“å¡ç‰‡å„ªåŒ– */
        .wish-item {
            display: flex; align-items: center; background: white;
            padding: 12px; border-radius: 12px; margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: opacity 0.3s;
        }
        .wish-item.checked { opacity: 0.5; text-decoration: line-through; }
        .wish-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .wish-info { flex: 1; margin-left: 15px; }
        .wish-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
        .wish-price { color: #ef4444; font-weight: 700; font-size: 16px; }

        /* å‹¾é¸æ¡†æ¨£å¼ */
        .check-btn {
            width: 24px; height: 24px; border: 2px solid #cbd5e1;
            border-radius: 50%; margin-right: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .checked .check-btn { background: #059669; border-color: #059669; color: white; }

        /* åº•éƒ¨çµç®—æ¬„ */
        .summary-bar {
            position: fixed; bottom: 70px; left: 0; right: 0;
            background: #1e293b; color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100;
        }
        .total-label { font-size: 14px; opacity: 0.8; }
        .total-amount { font-size: 20px; font-weight: 800; color: #fbbf24; }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #94a3b8; }
    </style>
</head>
<body>

<div class="container">
    <div id="wishlistContent">
        </div>
</div>

<div class="summary-bar" id="summaryBar" style="display: none;">
    <div>
        <span class="total-label">é è¨ˆæ¡è²·ç¸½é¡</span>
        <div class="total-amount" id="grandTotal">$0</div>
    </div>
    <button onclick="clearChecked()" style="background:#475569; color:white; border:none; padding:8px 15px; border-radius:8px; font-size:12px;">æ¸…é™¤å·²è³¼é …ç›®</button>
</div>

<script src="js/auth.js"></script>
<script src="js/components.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        renderWishlist();
    });

    function renderWishlist() {
        const user = getCurrentUser();
        if (!user) {
            location.href = "login.html";
            return;
        }

        const wishlist = JSON.parse(localStorage.getItem(`wishlist_${user.userId}`)) || [];
        const container = document.getElementById("wishlistContent");
        
        if (wishlist.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 50px;">ğŸ›’</div>
                    <h3>æ¸…å–®ç›®å‰æ˜¯ç©ºçš„</h3>
                    <p>åœ¨æ¯”åƒ¹æ™‚é»æ“Šæ„›å¿ƒï¼ŒæŠŠåˆ’ç®—çš„å•†å“å­˜ä¸‹ä¾†å§ï¼</p>
                    <a href="index.html" class="button" style="display:inline-block; margin-top:20px; background:var(--primary-color);">å»é€›é€›</a>
                </div>`;
            document.getElementById("summaryBar").style.display = "none";
            return;
        }

        // 1. æŒ‰åº—å®¶åˆ†çµ„è³‡æ–™
        const groups = wishlist.reduce((acc, item) => {
            if (!acc[item.storeName]) acc[item.storeName] = [];
            acc[item.storeName].push(item);
            return acc;
        }, {});

        // 2. æ¸²æŸ“ HTML
        let html = "";
        let grandTotal = 0;

        for (const storeName in groups) {
            const items = groups[storeName];
            const subtotal = items.reduce((sum, i) => sum + i.price, 0);
            grandTotal += subtotal;

            html += `
                <div class="store-group">
                    <div class="store-header">
                        <span class="store-name">ğŸ“ ${storeName}</span>
                        <span class="store-subtotal">å…± ${items.length} é …, å°è¨ˆ $${subtotal}</span>
                    </div>
                    ${items.map((item, idx) => `
                        <div class="wish-item ${item.checked ? 'checked' : ''}" id="item-${item.priceId}">
                            <div class="check-btn" onclick="toggleCheck('${item.priceId}')">
                                ${item.checked ? 'âœ“' : ''}
                            </div>
                            <img src="${item.productImg}" alt="">
                            <div class="wish-info">
                                <div class="wish-title">${item.productName}</div>
                                <div class="wish-price">$${item.price}</div>
                            </div>
                            <button onclick="removeItem('${item.priceId}')" style="background:none; border:none; color:#cbd5e1; font-size:18px;">âœ•</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        container.innerHTML = html;
        document.getElementById("grandTotal").innerText = `$${grandTotal}`;
        document.getElementById("summaryBar").style.display = "flex";
    }

    // å‹¾é¸åŠŸèƒ½ (æ¨¡æ“¬æ”¾å…¥è³¼ç‰©è»Š)
    function toggleCheck(priceId) {
        const user = getCurrentUser();
        let wishlist = JSON.parse(localStorage.getItem(`wishlist_${user.userId}`));
        const index = wishlist.findIndex(i => i.priceId === priceId);
        if (index !== -1) {
            wishlist[index].checked = !wishlist[index].checked;
            localStorage.setItem(`wishlist_${user.userId}`, JSON.stringify(wishlist));
            renderWishlist();
        }
    }

    // ç§»é™¤å–®ä¸€é …ç›®
    function removeItem(priceId) {
        if (!confirm("ç¢ºå®šè¦å¾æ¸…å–®ç§»é™¤å—ï¼Ÿ")) return;
        const user = getCurrentUser();
        let wishlist = JSON.parse(localStorage.getItem(`wishlist_${user.userId}`));
        wishlist = wishlist.filter(i => i.priceId !== priceId);
        localStorage.setItem(`wishlist_${user.userId}`, JSON.stringify(wishlist));
        renderWishlist();
    }

    // æ¸…é™¤æ‰€æœ‰å·²å‹¾é¸é …ç›® (æ¡è²·å®Œç•¢)
    function clearChecked() {
        const user = getCurrentUser();
        let wishlist = JSON.parse(localStorage.getItem(`wishlist_${user.userId}`));
        wishlist = wishlist.filter(i => !i.checked);
        localStorage.setItem(`wishlist_${user.userId}`, JSON.stringify(wishlist));
        renderWishlist();
    }
</script>

</body>
</html>