<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>修改價格｜GoodDeal</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* 主容器 */
.form-container {
	max-width: 1100px;
	margin: 40px auto;
	padding: 0 20px;
}

.form-card {
	background: #fff;
	border-radius: 20px;
	padding: 32px;
	box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
	border: 1px solid #f0f0f0;
}

/* 商品資訊摘要 */
.product-preview {
	max-width: 420px;
	margin: 0 auto 24px auto;
	background: var(--bg-gray);
	border-radius: 12px;
	padding: 16px;
	border-left: 4px solid var(--primary-color);
	box-sizing: border-box;
}

.store-badge {
	display: inline-block;
	background: var(--primary-color);
	color: #fff;
	font-size: 18px;
	padding: 2px 8px;
	border-radius: 4px;
	margin-bottom: 8px;
}

#productName {
	font-weight: bold;
	font-size: 24px;
	margin-bottom: 4px;
}

#productBrand {
	font-size: 18px;
	color: #777;
}

#productSpec {
	font-size: 18px;
	color: #777;
}

/* 輸入框群組 */
.form-group {
	max-width: 420px;
	margin: 0 auto 24px auto; /* 上 0, 左右自動(置中), 下 24px */
	text-align: left; /* 確保內部文字對齊左側 */
}

.form-group label {
	display: block;
	margin-bottom: 8px;
	font-size: 14px;
	font-weight: 500;
	color: #666;
}

.price-input-wrapper {
	position: relative;
	display: flex;
	align-items: center;
}

.price-input-wrapper span {
	position: absolute;
	left: 16px;
	font-weight: bold;
	color: #999;
}

.form-group input {
	width: 100%;
	padding: 14px 14px 14px 50px; /* 為 NT$ 留空間 */
	border-radius: 12px;
	border: 1px solid var(--border-color);
	font-size: 18px;
	font-weight: bold;
	box-sizing: border-box;
	transition: all 0.3s;
}

.form-group input:focus {
	outline: none;
	border-color: var(--primary-color);
	box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05);
}

/* 按鈕區 */
.btn-submit {
	display: block; /* 確保 margin: auto 有效 */
	width: 100%;
	max-width: 420px;
	margin: 0 auto 12px auto;
	padding: 16px;
	border-radius: 12px;
	border: none;
	background: var(--primary-color);
	color: #fff;
	font-size: 16px;
	font-weight: 600;
	cursor: pointer;
	transition: 0.3s;
}

.btn-submit:hover {
	opacity: 0.85;
	transform: translateY(-1px);
}

.btn-submit:disabled {
	background: #ccc;
	cursor: not-allowed;
}

.btn-back {
	display: block; /* 確保 margin: auto 有效 */
	width: 100%;
	max-width: 420px;
	margin: 0 auto;
	padding: 12px;
	background: none;
	border: none;
	color: #888;
	cursor: pointer;
	font-size: 14px;
	text-decoration: underline;
}
</style>
</head>
<body>


<main class="form-container">
	<div class="form-card">
		<div class="product-preview">
			<div class="store-badge" id="storeName">正在載入...</div>
			<div id="productName">商品名稱</div>
			<div id="productBrand">品牌</div>
			<div id="productSpec">規格</div>
		</div>

		<div class="form-group">
			<label for="price">最新通路售價</label>
			<div class="price-input-wrapper">
				<span>NT$</span> <input type="number" id="price" min="0" step="1" inputmode="numeric" placeholder="0">
			</div>
		</div>

		<button id="saveBtn" class="btn-submit" onclick="save()">儲存並記錄歷史</button>
		<button class="btn-back" onclick="history.back()">取消返回</button>
	</div>
</main>

<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/components.js"></script>
<script>
/* ========================
   1. 初始化與登入檢查
======================== */
const user = getCurrentUser();
const saveBtn = document.getElementById("saveBtn");
const priceId = new URLSearchParams(location.search).get("id");

if (!user) {
    alert("此功能需要登入會員");
    location.href = "login.html";
}

/* ========================
   2. 資料載入
======================== */
async function loadPriceData() {
    if (!priceId) return;
    try {
        const p = await apiGet(`/prices/${priceId}`);
        document.getElementById("storeName").innerText = p.store.storeName;
        document.getElementById("productName").innerText = p.product.productName;
        document.getElementById("productBrand").innerText = `品牌：${p.product.brand}`;
        document.getElementById("productSpec").innerText = `規格：${p.product.spec}`;
        document.getElementById("price").value = p.price;
    } catch (err) {
        console.error("載入失敗", err);
        alert("無法獲取價格資料");
    }
}

/* ========================
   3. 儲存邏輯
======================== */
async function save() {
    const priceValue = document.getElementById("price").value;

    if (!priceValue || priceValue < 0) {
        alert("請輸入有效的價格");
        return;
    }

    // UI 反饋
    saveBtn.disabled = true;
    saveBtn.innerText = "正在儲存...";

    try {
        await apiPut(`/prices/${priceId}`, { price: priceValue });
            
        // 成功提示與跳轉
        alert("價格已更新，系統已自動記錄本次變動");
        location.replace(document.referrer || 'index.html');
    } catch (err) {
        alert("儲存失敗，請檢查網路連線");
        saveBtn.disabled = false;
        saveBtn.innerText = "儲存並記錄歷史";
    }
}

// 防止輸入負數
document.getElementById("price").addEventListener("input", e => {
    if (e.target.value < 0) e.target.value = 0;
});

// 啟動載入
loadPriceData();

</script>
</body>
</html>
