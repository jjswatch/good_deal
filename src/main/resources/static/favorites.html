<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æˆ‘çš„æœ€æ„›ï½œGoodDeal</title>
<link rel="stylesheet" href="css/style.css" />

<style>
.container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px 16px 100px;
}

.favorite-card {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 16px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
    position: relative;
    border: 1px solid transparent;
}
.favorite-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    border-color: #e2e8f0;
}
.favorite-card img {
    width: 70px;
    height: 70px;
    border-radius: 12px;
    object-fit: cover;
    background: #f1f5f9;
}

.favorite-info {
    flex: 1;
    margin: 0 14px;
}

.favorite-title {
    font-size: 15px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.favorite-price {
    font-size: 14px;
    font-weight: 700;
    color: #ef4444;
}

.favorite-store {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 2px;
}

.favorite-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn {
    border-radius: 10px;
    padding: 8px 12px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    transition: all 0.2s;
}

.btn-add {
    background: #f0fdf4;
    color: #16a34a;
    border: 1px solid #bbf7d0;
}
.btn-add:hover { background: #16a34a; color: white; }

.btn-remove {
    background: #fff1f2;
    color: #e11d48;
    border: 1px solid #fecdd3;
}
.btn-remove:hover { background: #e11d48; color: white; }
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
}
.price-tag {
    display: flex;
    align-items: baseline;
    gap: 4px;
}
.currency { font-size: 12px; color: var(--danger-color); font-weight: bold; }
.amount { font-size: 18px; color: var(--danger-color); font-weight: 800; }
.removing {
    transform: translateX(100px);
    opacity: 0;
    transition: 0.4s;
}
</style>
</head>
<body>

<div class="container">
    <div id="favoriteList">
        </div>
</div>

<script src="js/auth.js"></script>
<script src="js/api.js"></script>
<script src="js/components.js"></script>
<script>
document.addEventListener("DOMContentLoaded", loadFavorites);

async function loadFavorites() {
	const user = getCurrentUser();
    if (!user) {
        location.href = "login.html?redirect=favorites.html";
        return;
    }

    try {
    	const favorites = await apiGet(`/favorites/user/${user.userId || user.id}`);
        const container = document.getElementById("favoriteList");

        if (!favorites || favorites.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size:64px; margin-bottom:16px;">ğŸ”</div>
                    <h3 style="color:#475569">æ¸…å–®ç©ºç©ºå¦‚ä¹Ÿ</h3>
                    <p>å°‡å¿ƒå„€çš„å•†å“åŠ å…¥æ”¶è—ï¼Œéš¨æ™‚è¿½è¹¤é™åƒ¹</p>
                    <button class="btn btn-add" style="margin-top:20px; padding:10px 24px" onclick="location.href='index.html'">å»é€›é€›</button>
                </div>`;
            return;
        }

        container.innerHTML = favorites.map(f => `
        <div class="favorite-card" id="fav-item-${f.favoriteId}" onclick="goToProduct(${f.product.productId})">
            <img src="${f.product.imageUrl || 'img/no-image.png'}" alt="product">
            <div class="favorite-info">
                <div class="favorite-title">${f.product.productName}</div>
                <div class="price-tag">
                    <span class="currency">$</span>
                    <span class="amount">${f.product.lowestPrice || '--'}</span>
                </div>
                <div class="favorite-store">ğŸ“ æœ€å„ªé¸ï¼š${f.product.bestStore || 'æ¯”åƒ¹ä¸­'}</div>
            </div>
            <div class="favorite-actions" onclick="event.stopPropagation()">
                <button class="btn btn-add" onclick="addToWishlist(${JSON.stringify(f.product).replace(/"/g, '&quot;')})">
                    ğŸ›’ æ¡è²·
                </button>
                <button class="btn btn-remove" onclick="removeFavorite(${f.favoriteId})">
                    ç§»é™¤
                </button>
            </div>
        </div>
    `).join("");

    } catch (e) {
    	console.error("è¼‰å…¥å¤±æ•—", e);
        document.getElementById("favoriteList").innerHTML = `<p style="text-align:center; padding:20px;">è³‡æ–™è¼‰å…¥ç•°å¸¸ï¼Œè«‹é‡æ–°ç™»å…¥</p>`;
    }
}

function goToProduct(id) {
    location.href = `product.html?id=${id}`;
}

function addToWishlist(product) {
    const user = getCurrentUser();
    const storageKey = `wishlist_${user.userId || user.id}`;
    let wishlist = JSON.parse(localStorage.getItem(storageKey)) || [];

    // æª¢æŸ¥æ˜¯å¦é‡è¤‡
    if (wishlist.some(item => item.productId === product.productId)) {
        alert("æ­¤å•†å“å·²åœ¨è³¼ç‰©æ¸…å–®ä¸­å›‰ï¼");
        return;
    }

    // åŠ å…¥æ¸…å–® (è£œå……åƒ¹æ ¼è³‡è¨Š)
    wishlist.push({
        productId: product.productId,
        productName: product.productName,
        price: product.lowestPrice || 0,
        imageUrl: product.imageUrl,
        addedAt: new Date().toISOString()
    });

    localStorage.setItem(storageKey, JSON.stringify(wishlist));
    
    // è¦–è¦ºå›é¥‹
    alert("âœ… å·²åŠ å…¥è³¼ç‰©æ¸…å–®ï¼");
}

async function removeFavorite(favoriteId) {
    const card = document.getElementById(`fav-item-${favoriteId}`);
    
    if (!confirm("ç¢ºå®šè¦å¾æ”¶è—ä¸­ç§»é™¤å—ï¼Ÿ")) return;

    try {
        // 1. å…ˆåšè¦–è¦ºæ•ˆæœï¼ˆUX å¿«é€ŸéŸ¿æ‡‰ï¼‰
        card.classList.add("removing");
        
        // 2. ç•°æ­¥å‘¼å«å¾Œç«¯ API
        await apiDelete(`/favorites/${favoriteId}`);

        // 3. ç­‰å‹•ç•«çµæŸå¾Œå¾¹åº•ç§»é™¤å…ƒç´ 
        setTimeout(() => {
            card.remove();
            // å¦‚æœåˆªå…‰äº†ï¼Œé‡æ–°æ•´ç†é¡¯ç¤ºç©ºç‹€æ…‹
            if (document.querySelectorAll('.favorite-card').length === 0) {
                loadFavorites();
            }
        }, 400);

    } catch (e) {
        card.classList.remove("removing");
        alert("ç§»é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
}
</script>

</body>
</html>
