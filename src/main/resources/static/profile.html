<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æœƒå“¡å€‹äººé é¢</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .container {
      padding: 20px 16px;
      max-width: 500px;
      margin: 0 auto;
      padding-bottom: 80px; /* ç•™å‡ºç©ºé–“çµ¦åº•éƒ¨å°è¦½ */
    }

    .card {
      background: #fff;
      padding: 24px;
      margin-bottom: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      border: 1px solid #f1f5f9;
    }
    
    .wishlist-entrance {
      background: linear-gradient(135deg, #fffcfb 0%, #fff5f2 100%);
      border: 1px solid #ffedd5 !important;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .wishlist-entrance:active {
      transform: scale(0.98);
    }

    /* è£é£¾ç”¨èƒŒæ™¯åœ“åœˆ */
    .wishlist-entrance::after {
      content: 'ğŸ›’';
      position: absolute;
      right: -10px;
      bottom: -10px;
      font-size: 80px;
      opacity: 0.05;
      transform: rotate(-15deg);
    }

    .wishlist-entrance h2 {
      color: #ea580c; /* æ©˜ç´…è‰²èª¿ */
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .wishlist-stats {
      background: #ff7849;
      color: white;
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: auto;
    }

    .view-all-label {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      color: #ea580c;
      font-weight: 700;
      font-size: 14px;
      margin-top: 10px;
    }

    .card h2 {
      margin: 0 0 20px 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 14px;
      color: var(--text-sub);
      margin-bottom: 6px;
      font-weight: 500;
    }

    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: #f8fafc;
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn-save {
      background: var(--primary-color);
      color: #fff;
      margin-top: 10px;
    }

    .btn-danger {
      background: #fee2e2;
      color: #dc2626;
      margin-top: 10px;
    }

    button:active {
      opacity: 0.8;
    }
    
    .btn-logout {
      background: transparent;
      color: #64748b;
      border: 1px solid #e2e8f0;
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-logout:hover {
      background: #f1f5f9;
      color: #ef4444;
      border-color: #fee2e2;
    }
  </style>
</head>
<body>



<div class="container">
	<div class="card store-entrance" onclick="location.href='preferred-stores.html'" style="cursor:pointer; background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border: 1px solid #ddd6fe !important;">
    	<div style="display: flex; align-items: center;">
        	<h2 style="margin: 0; color: #7c3aed;">ğŸª å¸¸å»è³£å ´è¨­å®š</h2>
        	<span id="storeCountTag" class="wishlist-stats" style="background: #8b5cf6; display:none;">0/3</span>
    	</div>
    	<p id="storeSummary" style="color: #5b21b6; font-size: 14px; margin-top: 8px;">è¨­å®šæ‚¨æœ€å¸¸å»çš„ 3 é–“è³£å ´ï¼Œæ¯”åƒ¹æ›´ç²¾æº–</p>
    	<div class="view-all-label" style="color: #7c3aed;">ç«‹å³è¨­å®š <span style="margin-left:5px">â†’</span></div>
	</div>
	
	<div class="card favorite-entrance" onclick="location.href='favorites.html'" style="cursor:pointer;"> 
		<div style="display:flex; align-items:center;"> 
			<h2 style="margin:0;">â¤ï¸ æˆ‘çš„æœ€æ„›</h2> 
			<span id="favoriteCountTag" class="wishlist-stats" style="display:none;">0</span> 
		</div> 
		<p id="favoriteSummary" style="color:#9a3412; font-size:14px; margin-top:8px;"> å°šæœªåŠ å…¥æœ€æ„› </p> 
		<div class="view-all-label"> æŸ¥çœ‹æˆ‘çš„æœ€æ„› <span style="margin-left:5px">â†’</span> </div> 
	</div>
	
	<div class="card wishlist-entrance" onclick="location.href='wishlist.html'" style="cursor:pointer;">
    	<div style="display: flex; align-items: center;">
      		<h2 style="margin: 0;">ğŸ›’ æˆ‘çš„è³¼ç‰©æ¸…å–®</h2>
      		<span id="wishlistCountTag" class="wishlist-stats" style="display:none;">0</span>
    	</div>
    	<p id="wishlistSummary" style="color: #9a3412; font-size: 14px; margin-top: 8px; position: relative; z-index: 1;">è¼‰å…¥æ¸…å–®ä¸­...</p>
    	<div class="view-all-label">ç«‹å³å‰å¾€æ¡è²· <span style="margin-left:5px">â†’</span></div>
	</div>

	<div class="card">
    	<h2>ğŸ‘¤ åŸºæœ¬è³‡æ–™</h2>
    	<div class="form-group">
      		<label>ä½¿ç”¨è€…åç¨±</label>
      		<input type="text" id="username" placeholder="è«‹è¼¸å…¥å§“å">
    	</div>
    	<div class="form-group">
      		<label>Email åœ°å€</label>
      		<input type="email" id="email" placeholder="example@mail.com">
    	</div>
    	<button class="btn-save" onclick="updateProfile()">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
  	</div>

  	<div class="card">
    	<h2>ğŸ” å®‰å…¨è¨­å®š</h2>
    	<div class="form-group">
      		<label>èˆŠå¯†ç¢¼</label>
      		<input type="password" id="oldPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    	</div>
    	<div class="form-group">
      		<label>æ–°å¯†ç¢¼</label>
      		<input type="password" id="newPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    	</div>
    	<div class="form-group">
      		<label>ç¢ºèªæ–°å¯†ç¢¼</label>
      		<input type="password" id="confirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    	</div>
    	<button class="btn-danger" onclick="changePassword()">ä¿®æ”¹å¯†ç¢¼</button>
  	</div>
  
  	<div style="margin-top: 30px; padding: 0 10px;">
    	<button class="btn-logout" onclick="handleLogout()">ğŸšª ç™»å‡ºå¸³è™Ÿ</button>
  	</div>
</div>

<script src="js/auth.js"></script>
<script src="js/api.js"></script>
<script src="js/components.js"></script>
<script>
// JavaScript é‚è¼¯ä¿æŒä¸è®Š...
async function loadProfile() {
	loadStoreSummary();
    try {
        // å„ªå…ˆé¡¯ç¤ºæ¸…å–®è³‡è¨Š (æœ¬åœ°è³‡æ–™ï¼Œè¼ƒå¿«)
      	loadWishlistSummary();

      	// åŒæ­¥ API æœƒå“¡è³‡æ–™
      	const user = await apiGet("/user/profile");
      	if(user) {
        	document.getElementById("username").value = user.username || "";
        	document.getElementById("email").value = user.email || "";
      	}
    } catch (err) {
      	console.warn("API è¼‰å…¥å¤±æ•—æˆ–æœªç™»å…¥");
    }
}

async function loadStoreSummary() {
	const user = await apiGet("/user/profile");
    if (!user) return;
    try {
        const stores = await apiGet(`/user/preferred-stores/${user.userId}`);
        const count = stores.length;
        if (count > 0) {
            document.getElementById("storeSummary").innerHTML = 
                `ç›®å‰å·²è¨­å®šï¼š<b>${stores.map(s => s.store.storeName).join('ã€')}</b>`;
            const tag = document.getElementById("storeCountTag");
            tag.innerText = `${count}/3`;
            tag.style.display = "block";
        }
    } catch (e) { console.error("ç„¡æ³•è¼‰å…¥è³£å ´æ‘˜è¦"); }
}

async function updateProfile() {
    const username = document.getElementById("username").value;
    const email = document.getElementById("email").value;
    if (!username || !email) { alert("è³‡æ–™ä¸å¯ç©ºç™½"); return; }
    try {
    	await apiPut("/user/profile", { username, email });
      	alert("æœƒå“¡è³‡æ–™å·²æ›´æ–°");
    } catch (err) {
      	alert("æ›´æ–°å¤±æ•—ï¼š" + err.message);
    }
}

async function changePassword() {
    const oldPwd = document.getElementById("oldPassword").value;
    const newPwd = document.getElementById("newPassword").value;
    const confirmPwd = document.getElementById("confirmPassword").value;
    if (!oldPwd || !newPwd) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }
    if (newPwd !== confirmPwd) { alert("æ–°å¯†ç¢¼ä¸ä¸€è‡´"); return; }
    try {
    	await apiPut("/user/password", { oldPassword: oldPwd, newPassword: newPwd });
      	alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥");
      	logout();
    } catch (err) {
      	alert("ä¿®æ”¹å¤±æ•—ï¼š" + err.message);
    }
}

function loadWishlistSummary() {
	const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
	if (user) {
		const wishlist = JSON.parse(localStorage.getItem(`wishlist_${user.userId}`)) || [];
	    const count = wishlist.length;
	    const total = wishlist.reduce((sum, item) => sum + item.price, 0); 
	    const summaryText = count > 0 ? `ç›®å‰å·²å­˜ <b>${count}</b> ç­†å„ªæƒ ï¼Œé è¨ˆèŠ±è²» <b>$${total}</b>` : "ç›®å‰é‚„æ²’æœ‰æƒ³è²·çš„å•†å“ï¼Œå¿«å»æœå°‹æ¯”åƒ¹å§ï¼";
	      
	    document.getElementById("wishlistSummary").innerHTML = summaryText;

	    // å¦‚æœæœ‰å•†å“ï¼Œé¡¯ç¤ºæ©˜è‰²å°æ¨™ç±¤
	    if (count > 0) {
	    	const tag = document.getElementById("wishlistCountTag");
	        tag.innerText = count;
	        tag.style.display = "block";
	    }
	}
}

function handleLogout() {
	if (confirm("ç¢ºå®šè¦ç™»å‡º GoodDeal å—ï¼Ÿ")) {
	    if (typeof logout === 'function') {
	    	logout();
	    } else {
	        localStorage.removeItem("user");
	        localStorage.removeItem("token");
	        // ä¹Ÿå¯ä»¥é¸æ“‡æ¸…é™¤æ¸…å–®ï¼Œä½†é€šå¸¸å»ºè­°ä¿ç•™è³¼ç‰©æ¸…å–®åœ¨æœ¬åœ°
	        // localStorage.removeItem("wishlist_..."); 
	    }
	      
	    alert("å·²å®‰å…¨ç™»å‡º");
	    window.location.href = "index.html"; // å°å›é¦–é 
	}
}

loadWishlistSummary(); // åœ¨é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
  
loadProfile();
</script>
</body>
</html>
