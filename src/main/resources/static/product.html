<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GoodDealï½œå•†å“æ¯”åƒ¹å¹³å°</title>
<link rel="stylesheet" href="css/style.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
	--primary-red: #FF4500;
	--secondary-red: #ef4444;
	--text-dark: #1e293b;
	--text-gray: #64748b;
	--bg-light: #f8fafc;
	--border-color: #e2e8f0;
}

.container {
	max-width: 1100px;
	margin: 0 auto;
	padding: 0 20px;
}

/* å•†å“å¡ç‰‡ */
#productInfo {
	background: white;
	border-radius: 16px;
	padding: 24px;
	margin: 20px auto;
	box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
	display: flex;
	gap: 30px;
	text-align: left;
	align-items: flex-start;
}

#productInfo img {
	width: 220px;
	height: 220px;
	object-fit: contain;
	border-radius: 12px;
	background: #f8fafc;
	flex-shrink: 0;
}

.product-detail-content {
	flex-grow: 1;
	display: flex;
	flex-direction: column;
}

.product-name {
	font-size: 1.6rem;
	font-weight: 800;
	margin: 0 0 12px 0;
	color: var(--text-dark);
	line-height: 1.3;
}

.product-desc {
	font-size: 0.95rem;
	color: var(--text-gray);
	line-height: 1.6;
	margin-bottom: 15px;
	/* é™åˆ¶æè¿°ç‚º 3 è¡Œï¼Œè¶…éé¡¯ç¤ºçœç•¥è™Ÿ */
	display: -webkit-box;
	-webkit-line-clamp: 3;
	-webkit-box-orient: vertical;
	overflow: hidden;
}

.product-meta {
	font-size: 0.85rem;
	color: var(--text-gray);
}

.product-meta-tags {
	display: flex;
	flex-wrap: wrap;
	gap: 8px;
	margin-top: 10px;
}

.meta-tag {
	font-size: 0.75rem;
	padding: 4px 10px;
	background: #f1f5f9;
	color: #475569;
	border-radius: 6px;
	border: 1px solid #e2e8f0;
}

/* åƒ¹æ ¼æ‘˜è¦å¡ç‰‡ */
.best-price-card {
	display: inline-flex;
	flex-direction: column;
	align-items: center;
	background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
	border: 2px solid var(--border-color);
	border-radius: 20px;
	padding: 20px 40px;
	margin: 20px 0;
	box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04);
	width: 100%;
	max-width: 450px;
	box-sizing: border-box;
}

.best-price-label {
	font-size: 12px;
	font-weight: 700;
	padding: 4px 12px;
	border-radius: 50px;
	margin-bottom: 12px;
}

.label-history {
	background: #fee2e2;
	color: var(--secondary-red);
	border: 1px solid #fecaca;
}

.label-recent {
	background: #dbeafe;
	color: #2563eb;
	border: 1px solid #bfdbfe;
}

.best-price-value {
	font-size: 36px;
	font-weight: 900;
	color: var(--text-dark);
	display: flex;
	align-items: center;
	gap: 10px;
}

/* è¶¨å‹¢åœ–å®¹å™¨ */
.mini-chart-container {
	width: 100%;
	height: 100px;
	margin-top: 15px;
}

/* å»ºè­°æ¨™ç±¤ */
.buy-signal {
	padding: 4px 8px;
	border-radius: 6px;
	font-size: 12px;
	font-weight: bold;
}

.signal-buy {
	background: #d1fae5;
	color: #059669;
}

.signal-wait {
	background: #fef3c7;
	color: #d97706;
}

/* å›å ±æ¸…å–® */
.report-section {
	margin-top: 40px;
	text-align: left;
}

.section-title {
	font-size: 18px;
	border-left: 4px solid var(--primary-red);
	padding-left: 12px;
	margin-bottom: 15px;
}

.report-item {
	background: #fff;
	border: 1px solid var(--border-color);
	border-radius: 12px;
	padding: 12px 16px;
	margin-bottom: 10px;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.user-avatar {
	width: 32px;
	height: 32px;
	background: #e2e8f0;
	border-radius: 50%;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 12px;
	color: var(--text-gray);
}

.report-price {
	font-weight: 700;
	color: var(--secondary-red);
	margin-left: 8px;
}

/* å½ˆçª—æ¨£å¼ */
.modal {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.5);
	z-index: 1000;
	align-items: center;
	justify-content: center;
	backdrop-filter: blur(4px);
}

.modal-content {
	background: white;
	padding: 24px;
	border-radius: 20px;
	width: 90%;
	max-width: 400px;
}

.form-group {
	margin-bottom: 16px;
}

.form-group label {
	display: block;
	margin-bottom: 6px;
	font-weight: 600;
}

.form-group input, .form-group select {
	width: 100%;
	padding: 12px;
	border-radius: 8px;
	border: 1px solid #ddd;
	box-sizing: border-box;
}

/* æŒ‰éˆ• */
.button {
	display: inline-block;
	padding: 12px 24px;
	border-radius: 10px;
	text-decoration: none;
	font-weight: 600;
	cursor: pointer;
	border: none;
	transition: 0.3s;
	text-align: center;
}

.btn-primary {
	background: var(--primary-red);
	color: white;
}

.btn-dark {
	background: black;
	color: white;
}

.btn-gray {
	background: #94a3b8;
	color: white;
}

.button:hover {
	opacity: 0.9;
	transform: translateY(-1px);
}

/* åº•éƒ¨å°è¦½ (Mobile) */
.sticky-action-bar {
	position: fixed;
	bottom: 0;
	left: 0;
	right: 0;
	height: 70px;
	background: white;
	display: flex;
	box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.1);
	z-index: 999;
	padding-bottom: env(safe-area-inset-bottom);
}

.action-item {
	flex: 1;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	font-size: 16px;
	color: var(--text-gray);
	cursor: pointer;
	position: relative;
}

.action-item.active {
	color: var(--primary-red);
	font-weight: bold;
}

.reward-badge {
	position: absolute;
	top: 5px;
	right: 15%;
	background: var(--primary-red);
	color: white;
	font-size: 9px;
	padding: 2px 6px;
	border-radius: 10px;
	animation: bounce 2s infinite;
}

@keyframes bounce { 0%, 100% {
	transform: translateY(0); } 50% { transform:translateY(-5px); }
}

@media ( min-width : 769px) {
	.sticky-action-bar { display: none; }
}

@media ( max-width : 768px) {
	.desktop-buttons { display: none; }
	#productInfo {
		flex-direction: column; /* è®Šå›ä¸Šä¸‹æ’åˆ— */
		align-items: center;
		text-align: center;
		padding: 20px;
		gap: 15px;
	}
	#productInfo img {
		width: 160px; /* æ‰‹æ©Ÿä¸Šç¸®å°åœ–ç‰‡ */
		height: 160px;
	}
	.product-name {
		font-size: 1.3rem;
	}
	.product-meta-tags {
		justify-content: center; /* æ‰‹æ©Ÿä¸Šæ¨™ç±¤ç½®ä¸­ */
	}
	.best-price-value {
		font-size: 28px;
	}
}
</style>
</head>

<body>
<nav class="main-nav">
	<div class="nav-container">
		<div class="nav-back" onclick="history.back()">
        	<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
		</div>

		<div class="nav-notification" onclick="handleNotificationClick()">
			<svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
			<div class="notification-dot" id="notiDot"></div>
		</div>
	</div>
</nav>

<div class="container">
	<div id="productInfo">
		<p style="color: #94a3b8;">å•†å“è³‡æ–™è¼‰å…¥ä¸­...</p>
	</div>

	<div class="report-section">
		<h3 class="section-title">æœ€æ–°æœƒå“¡å›å ±åƒ¹æ ¼</h3>
		<ul id="reportList" style="list-style: none; padding: 0;">
			<li style="color: #94a3b8; text-align: center; padding: 20px;">è¼‰å…¥å›å ±ç´€éŒ„ä¸­...</li>
		</ul>
	</div>

	<div class="desktop-buttons" style="text-align: center; margin-top: 30px;">
		<button class="button btn-dark" onclick="goCompare()">æŸ¥çœ‹æ¯”åƒ¹</button>
		<button class="button btn-primary" onclick="openReportModal()">å›å ±åƒ¹æ ¼</button>
		<button class="button btn-dark" onclick="goHistory()">æ­·å²åƒ¹æ ¼</button>
	</div>
</div>

<div id="reportModal" class="modal">
	<div class="modal-content">
		<h3 style="margin-top: 0">å›å ±å•†å“åƒ¹æ ¼</h3>
		<p id="modalProductName" style="color: #666; font-size: 14px; margin-bottom: 20px;"></p>
		<div class="form-group">
			<label>é€šè·¯åº—å®¶</label> 
			<select id="reportStore">
				<option value="">è¼‰å…¥åº—å®¶...</option>
			</select>
		</div>
		<div class="form-group">
			<label>ç›®å‰å”®åƒ¹ ($)</label> <input type="number" id="reportPrice" 	placeholder="è«‹è¼¸å…¥çœ‹åˆ°çš„åƒ¹æ ¼">
		</div>
		<button onclick="submitReport()" class="button btn-primary" style="width: 100%; margin-bottom: 10px;">é€å‡ºå›å ±</button>
		<button onclick="closeReportModal()" class="button btn-gray" style="width: 100%;">å–æ¶ˆ</button>
	</div>
</div>

<div class="sticky-action-bar">
	<div class="action-item" onclick="goCompare()">
		<span>ğŸ” æ¯”åƒ¹å»</span>
	</div>
	<div class="action-item active" onclick="openReportModal()">
		<div class="reward-badge">+10pt</div>
		<span>ğŸ“¢ å›å ±åƒ¹æ ¼</span>
	</div>
	<div class="action-item" onclick="goHistory()">
		<span>ğŸ“ˆ æ­·å²åƒ¹</span>
	</div>
</div>

<script src="js/api.js"></script>
<script src="js/auth.js"></script>

<script>
const params = new URLSearchParams(window.location.search);
const productId = params.get("id");
let miniChartInstance = null;

if (productId) {
    initProductPage(productId);
}

async function initProductPage(id) {
    try {
        const [product, priceSummary] = await Promise.all([
            apiGetPublic(`/products/${id}`),
            apiGetPublic(`/products/${id}/price-lowest`)
        ]);

        renderProductBasic(product);
        renderPriceSummary(priceSummary);
        renderReportList(id);
        loadHistoryAndChart(id);
    } catch (err) {
        console.error("è³‡æ–™åˆå§‹åŒ–å¤±æ•—:", err);
    }
}

function renderProductBasic(p) {
    document.getElementById("productInfo").innerHTML = `
        <img src="${p.imageUrl || 'assets/placeholder.png'}" alt="${p.productName}">
        
        <div class="product-detail-content">
            <div>
                <h2 class="product-name">${p.brand} ${p.productName}</h2>
                <p class="product-desc">${p.description || "å°šç„¡å•†å“ä»‹ç´¹"}</p>
            </div>
            
            <div id="price-container"></div> 

            <div class="product-meta-tags">
                <span class="meta-tag">è¦æ ¼ï¼š${p.spec}</span>
                <span class="meta-tag">æ¢ç¢¼ï¼š${p.barcode}</span>
            </div>
        </div>
    `;
}

function renderPriceSummary(data) {
    const container = document.getElementById("price-container");
    const history = data.historical;
    const recent = data.recent30Days;

    if (!history && !recent) {
        container.innerHTML = `<p style="color:#94a3b8">ç›®å‰æš«ç„¡åƒ¹æ ¼ç´€éŒ„</p>`;
        return;
    }

    const displayData = recent || history;
    const labelText = recent ? "âš¡ è¿‘ 30 å¤©æœ€ä½" : "ğŸ† æ­·å²æœ€ä½åƒ¹";
    const labelClass = recent ? "label-recent" : "label-history";
    
    // å»ºè­°å…¥æ‰‹é‚è¼¯
    const isGoodPrice = history ? (displayData.price <= history.price * 1.05) : true;
    const signalHTML = isGoodPrice 
        ? `<span class="buy-signal signal-buy">ğŸ”¥ å»ºè­°å…¥æ‰‹</span>` 
        : `<span class="buy-signal signal-wait">â³ å»ºè­°è§€æœ›</span>`;

    container.innerHTML = `
        <div class="best-price-card">
            <span class="best-price-label ${labelClass}">${labelText}</span>
            <div class="best-price-value">
                $${displayData.price}
                ${signalHTML}
            </div>
            <div class="mini-chart-container">
                <canvas id="miniTrendChart"></canvas>
            </div>
        </div>
    `;
}

async function loadHistoryAndChart(id) {
    let historyData = getCachedHistory(id);
    if (!historyData) {
        historyData = await apiGetPublic(`/history/product/${id}`);
        setCachedHistory(id, historyData);
    }

    const chartPrices = historyData && historyData.length >= 2 
        ? historyData.map(item => item.newPrice).reverse()
        : [159, 155, 160, 145, 145, 142, 139]; // é è¨­æ¨¡æ“¬æ•¸æ“š

    renderMiniChart(chartPrices);
}

function renderMiniChart(dataToUse) {
    const ctx = document.getElementById('miniTrendChart')?.getContext('2d');
    if (!ctx) return;

    if (miniChartInstance) miniChartInstance.destroy();

    miniChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dataToUse.map(() => ''),
            datasets: [{
                data: dataToUse,
                borderColor: '#FF4500',
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                backgroundColor: 'rgba(255, 69, 0, 0.05)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            scales: { x: { display: false }, y: { display: false } }
        }
    });
}

async function renderReportList(id) {
    const listContainer = document.getElementById("reportList");
    try {
        const reports = await apiGetPublic(`/price-reports/product/${id}?limit=5`);
        if (!reports?.length) {
            listContainer.innerHTML = `<li style="text-align:center;color:#94a3b8">å°šç„¡å›å ±ç´€éŒ„</li>`;
            return;
        }

        listContainer.innerHTML = reports.map(r => `
            <li class="report-item">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="user-avatar">${(r.userName || "U")[0]}</div>
                    <div>
                        <span style="font-size:11px; background:#f1f5f9; padding:2px 6px; border-radius:4px;">${r.storeName}</span>
                        <strong>${r.userName}</strong> <span class="report-price">$${r.price}</span>
                    </div>
                </div>
                <div style="font-size:12px; color:#94a3b8">${formatTimeAgo(r.date)}</div>
            </li>
        `).join("");
    } catch (err) {
        listContainer.innerHTML = `<li>è¼‰å…¥å¤±æ•—</li>`;
    }
}

// é€šç”¨é‚è¼¯å‡½æ•¸
function formatTimeAgo(time) {
    const diff = (Date.now() - new Date(time)) / 1000;
    if (diff < 60) return "å‰›å‰›";
    if (diff < 3600) return `${Math.floor(diff / 60)} åˆ†å‰`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} å°æ™‚å‰`;
    return `${Math.floor(diff / 86400)} å¤©å‰`;
}

function openReportModal() {
    if (!getCurrentUser()) {
        alert("ç™»å…¥å¾Œå³å¯å›å ±åƒ¹æ ¼ä¸¦é ˜å–ç©åˆ†ï¼");
        location.href = "login.html";
        return;
    }
    document.getElementById("modalProductName").textContent = document.querySelector(".product-name")?.textContent;
    document.getElementById("reportModal").style.display = "flex";
    loadStoreOptions();
}

function closeReportModal() { document.getElementById("reportModal").style.display = "none"; }

async function loadStoreOptions() {
    const select = document.getElementById("reportStore");
    try {
        const stores = await apiGetPublic("/stores");
        select.innerHTML = `<option value="">è«‹é¸æ“‡åº—å®¶</option>` + 
            stores.map(s => `<option value="${s.storeId}">${s.storeName}</option>`).join("");
    } catch (err) {
        select.innerHTML = `<option>è¼‰å…¥å¤±æ•—</option>`;
    }
}

async function submitReport() {
    const storeId = document.getElementById("reportStore").value;
    const price = document.getElementById("reportPrice").value;
    if (!storeId || !price) return alert("è«‹å®Œæ•´å¡«å¯«å…§å®¹");

    try {
        await apiPost("/price-reports", {
            productId, storeId, reportedPrice: parseFloat(price), userId: getCurrentUser().id
        });
        alert("å›å ±æˆåŠŸï¼å¯©æ ¸é€šéå¾Œå°‡ç™¼é€ç©åˆ†");
        localStorage.removeItem(`priceHistory_${productId}`);
        closeReportModal();
        renderReportList(productId);
    } catch (err) { alert(err.message); }
}

// é é¢è·³è½‰
function goCompare() { location.href = `compare.html?id=${productId}`; }
function goHistory() { location.href = `history.html?productId=${productId}`; }

// å¿«å–ç®¡ç†
function getCachedHistory(id) {
    const raw = localStorage.getItem(`priceHistory_${id}`);
    if (!raw) return null;
    const cached = JSON.parse(raw);
    return (Date.now() - cached.timestamp < 600000) ? cached.data : null;
}
function setCachedHistory(id, data) {
    localStorage.setItem(`priceHistory_${id}`, JSON.stringify({ timestamp: Date.now(), data }));
}
</script>
</body>
</html>