<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æˆ‘çš„æœ€æ„›ï½œGoodDeal</title>
<link rel="stylesheet" href="css/style.css" />

<style>
    /* åŸºç¤å®¹å™¨å„ªåŒ– */
    .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px 16px 100px;
    }

    .header-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .page-title {
        font-size: 20px;
        font-weight: 800;
        color: #1e293b;
    }

    /* å•†å“å¡ç‰‡å„ªåŒ– */
    .favorite-card {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 16px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        position: relative;
        border: 1px solid transparent;
    }

    .favorite-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        border-color: #e2e8f0;
    }

    .favorite-card img {
        width: 75px;
        height: 75px;
        border-radius: 12px;
        object-fit: cover;
        background: #f1f5f9;
    }

    .favorite-info {
        flex: 1;
        margin: 0 14px;
    }

    /* âœ¨ å“ç‰Œæ¨™ç±¤æ¨£å¼ */
    .brand-label {
        font-size: 11px;
        font-weight: 700;
        color: #64748b;
        background: #f1f5f9;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 4px;
    }

    .favorite-title {
        font-size: 15px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 6px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .price-tag {
        display: flex;
        align-items: baseline;
        gap: 2px;
    }
    .currency { font-size: 12px; color: #ef4444; font-weight: bold; }
    .amount { font-size: 18px; color: #ef4444; font-weight: 800; }

    .favorite-store {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 2px;
    }

    .favorite-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* æŒ‰éˆ•å„ªåŒ– */
    .btn {
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 600;
        white-space: nowrap;
        border: 1px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
    }

    .btn-add {
        background: #f0fdf4;
        color: #16a34a;
        border-color: #bbf7d0;
    }
    .btn-add:hover { background: #16a34a; color: white; }

    .btn-remove {
        background: #fff1f2;
        color: #e11d48;
        border-color: #fecdd3;
    }
    .btn-remove:hover { background: #e11d48; color: white; }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #94a3b8;
    }

    .removing {
        transform: translateX(50px);
        opacity: 0;
        transition: 0.4s;
    }
</style>
</head>
<body>
<nav>
	<div class="nav-container">
		<div style="margin-left: auto; display: flex; align-items: center;">
			<div class="nav-notification" onclick="location.href='setting.html'">
				<svg class="nav-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
	            <div class="notification-dot" id="notiDot"></div>
	        </div>
	    </div>
	</div>
</nav>
<div class="container">
    <div class="header-bar">
        <div class="page-title">â¤ï¸ æˆ‘çš„æœ€æ„›</div>
    </div>

    <div id="favoriteList">
        </div>
</div>

<script src="js/auth.js"></script>
<script src="js/api.js"></script>
<script src="js/components.js"></script>
<script>
document.addEventListener("DOMContentLoaded", loadFavorites);

async function loadFavorites() {
    const user = getCurrentUser();
    if (!user) {
        location.href = "login.html?redirect=favorites.html";
        return;
    }

    try {
        const favorites = await apiGet(`/favorites/user/${user.userId || user.id}`);
        const container = document.getElementById("favoriteList");

        if (!favorites || favorites.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size:64px; margin-bottom:16px;">ğŸ”</div>
                    <h3>é‚„æ²’æœ‰æ”¶è—å•†å“</h3>
                    <p>çœ‹åˆ°åˆ’ç®—çš„å•†å“å°±å…ˆå­˜èµ·ä¾†å§ï¼</p>
                    <button class="btn btn-add" style="margin-top:20px; padding:10px 24px" onclick="location.href='index.html'">å»é€›é€›</button>
                </div>`;
            return;
        }

        for (let f of favorites) {
            try {
                const strategy = await apiGet(
                  `/strategy/product/${f.product.productId}?userId=${user.userId || user.id}`
                );

                f.product.lowestPrice = strategy.price;
                f.product.bestStore = strategy.store;
            } catch (e) {
                console.warn("æ¯”åƒ¹å¤±æ•—", f.product.productId);
            }
        }

        container.innerHTML = favorites.map(f => `
            <div class="favorite-card" id="fav-item-${f.product.productId}" onclick="goToProduct(${f.product.productId})">
                <img src="${f.product.imageUrl || 'img/no-image.png'}" alt="product">
                <div class="favorite-info">
                    <div class="brand-label">${f.product.brand || 'ä¸€èˆ¬å“ç‰Œ'}</div>
                    <div class="favorite-title">${f.product.productName}</div>
                    <div class="price-tag">
                        <span class="currency">$</span>
                        <span class="amount">${f.product.lowestPrice || '--'}</span>
                    </div>
                    <div class="favorite-store">ğŸ“ æœ€å„ªï¼š${f.product.bestStore || 'æ¯”åƒ¹ä¸­'}</div>
                </div>
                <div class="favorite-actions" onclick="event.stopPropagation()">
                    <button class="btn btn-add" onclick="addToWishlist(${JSON.stringify(f.product).replace(/"/g, '&quot;')})">
                        ğŸ›’ æ¡è²·
                    </button>
                    <button class="btn btn-remove" onclick="removeFavorite(${f.product.productId})">
                        ç§»é™¤
                    </button>
                </div>
            </div>
        `).join("");

    } catch (e) {
        console.error("è¼‰å…¥å¤±æ•—", e);
        document.getElementById("favoriteList").innerHTML = `<p style="text-align:center; padding:20px;">ç„¡æ³•è®€å–æ”¶è—æ¸…å–®</p>`;
    }
}

function goToProduct(id) {
    location.href = `product.html?id=${id}`;
}

// âœ¨ ä¿®æ”¹æ­¤è™•ï¼šç¢ºä¿ brand è¢«å­˜å…¥ localStorage
function addToWishlist(product) {
    const user = getCurrentUser();
    const uid = user.userId || user.id;
    const storageKey = `wishlist_${uid}`;
    let wishlist = JSON.parse(localStorage.getItem(storageKey)) || [];

    if (wishlist.some(item => item.productId === product.productId)) {
        if (confirm("æ­¤å•†å“å·²åœ¨è³¼ç‰©æ¸…å–®ä¸­ï¼Œè¦å‰å¾€æ¡è²·åˆ†æå—ï¼Ÿ")) {
            location.href = "wishlist.html";
        }
        return;
    }

    wishlist.push({
        productId: product.productId,
        priceId: `fav-${product.productId}-${Date.now()}`,
        brand: product.brand || "", // å­˜å…¥å“ç‰Œ
        productName: product.productName,
        price: product.lowestPrice || 0,
        productImg: product.imageUrl,
        storeName: product.bestStore || "æœªæŒ‡å®šåº—å®¶", // é è¨­å¸¶å…¥æœ€å„ªåº—å®¶
        addedAt: new Date().toLocaleDateString(),
        checked: false
    });

    localStorage.setItem(storageKey, JSON.stringify(wishlist));
    if (confirm("âœ… å·²åŠ å…¥æ¡è²·æ¸…å–®ï¼è¦ç«‹å³æŸ¥çœ‹æ¡è²·åˆ†æå—ï¼Ÿ")) {
        location.href = "wishlist.html";
    }
}

async function removeFavorite(productId) {
    if (!confirm("ç¢ºå®šè¦å¾æ”¶è—ä¸­ç§»é™¤å—ï¼Ÿ")) return;

    const user = getCurrentUser();

    await apiDelete(
        `/favorites?userId=${user.userId || user.id}&productId=${productId}`
    );

    document.getElementById(`fav-item-${productId}`)?.remove();
}
</script>
</body>
</html>